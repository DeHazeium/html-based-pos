<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS System</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #141414;
            --bg-tertiary: #1e1e1e;
            --text-primary: #ffffff;
            --text-secondary: #888888;
            --border: #2a2a2a;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: var(--bg-primary);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 9999;
        }

        .login-screen.hidden {
            display: none;
        }

        .login-container {
            background: var(--bg-secondary);
            padding: 50px;
            border-radius: 2px;
            border: 1px solid var(--border);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .login-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 36px;
            color: var(--text-primary);
            margin-bottom: 8px;
            letter-spacing: 6px;
        }

        .login-subtitle {
            color: var(--text-secondary);
            margin-bottom: 40px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .pin-display {
            background: var(--bg-tertiary);
            padding: 25px;
            border-radius: 2px;
            margin-bottom: 30px;
            font-size: 32px;
            letter-spacing: 16px;
            min-height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--border);
            font-family: 'Bebas Neue', sans-serif;
        }

        .pin-display.error {
            border-color: #ffffff;
            animation: shake 0.3s ease;
        }

        .numpad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .numpad-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            padding: 0;
            height: 70px;
            width: 100%;
            border-radius: 2px;
            color: var(--text-primary);
            font-size: 24px;
            font-weight: 300;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Montserrat', sans-serif;
        }

        .numpad-btn:hover {
            background: var(--bg-primary);
            border-color: var(--text-primary);
        }

        .numpad-btn:active {
            background: var(--text-primary);
            color: var(--bg-primary);
        }

        /* Main Container */
        .container {
            max-width: 100%;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
        }

        .logo {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 24px;
            color: var(--text-primary);
            letter-spacing: 4px;
        }

        .mode-selector {
            display: flex;
            gap: 0;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
        }

        .mode-btn {
            padding: 12px 30px;
            font-size: 11px;
            font-weight: 500;
            border: none;
            border-right: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s ease;
            background: transparent;
            color: var(--text-secondary);
            font-family: 'Montserrat', sans-serif;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .mode-btn:last-child {
            border-right: none;
        }

        .mode-btn.active {
            background: var(--text-primary);
            color: var(--bg-primary);
        }

        .logout-btn {
            padding: 12px 24px;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-primary);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Montserrat', sans-serif;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .logout-btn:hover {
            background: var(--text-primary);
            color: var(--bg-primary);
        }

        .panel {
            display: none;
        }

        .panel.active {
            display: block;
        }

        /* Cashier Layout */
        .cashier-layout {
            display: grid;
            grid-template-columns: 1fr 420px;
            gap: 20px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--bg-secondary);
            padding: 25px;
            border: 1px solid var(--border);
        }

        .stat-card h3 {
            font-size: 10px;
            color: var(--text-secondary);
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 500;
        }

        .stat-card .value {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 32px;
            color: var(--text-primary);
            letter-spacing: 2px;
        }

        .menu-section {
            background: var(--bg-secondary);
            padding: 25px;
            border: 1px solid var(--border);
        }

        .section-title {
            font-size: 10px;
            color: var(--text-secondary);
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 500;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 10px;
            margin-bottom: 30px;
        }

        .menu-item {
            background: var(--bg-tertiary);
            padding: 20px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .menu-item:hover {
            background: var(--text-primary);
            color: var(--bg-primary);
        }

        .menu-item:hover .price {
            color: var(--bg-primary);
        }

        .menu-item h3 {
            font-size: 12px;
            margin-bottom: 10px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .menu-item:hover h3 {
            color: var(--bg-primary);
        }

        .menu-item .price {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 20px;
            color: var(--text-primary);
            letter-spacing: 1px;
        }

        .order-panel {
            background: var(--bg-secondary);
            padding: 25px;
            border: 1px solid var(--border);
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .order-items {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .order-items::-webkit-scrollbar {
            width: 6px;
        }

        .order-items::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
        }

        .order-items::-webkit-scrollbar-thumb {
            background: var(--text-secondary);
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: var(--bg-tertiary);
            margin-bottom: 10px;
            border: 1px solid var(--border);
        }

        .order-item-info h4 {
            font-size: 12px;
            margin-bottom: 5px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .order-item-info .item-price {
            color: var(--text-secondary);
            font-size: 11px;
        }

        .remove-btn {
            background: transparent;
            border: 1px solid var(--border);
            padding: 6px 12px;
            color: var(--text-primary);
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Montserrat', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .remove-btn:hover {
            background: var(--text-primary);
            color: var(--bg-primary);
        }

        .total-section {
            background: var(--bg-tertiary);
            padding: 25px;
            border: 1px solid var(--border);
            margin-bottom: 20px;
            text-align: center;
        }

        .total-label {
            font-size: 10px;
            color: var(--text-secondary);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .total-amount {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 36px;
            color: var(--text-primary);
            letter-spacing: 2px;
        }

        .action-btn {
            width: 100%;
            padding: 16px;
            margin: 8px 0;
            font-size: 10px;
            font-weight: 500;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Montserrat', sans-serif;
            text-transform: uppercase;
            letter-spacing: 2px;
            background: transparent;
            color: var(--text-primary);
        }

        .action-btn:hover {
            background: var(--text-primary);
            color: var(--bg-primary);
        }

        .btn-primary {
            border-color: var(--text-primary);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            padding: 40px;
            border: 1px solid var(--border);
            max-width: 500px;
            width: 90%;
        }

        .modal-content h3 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 24px;
            color: var(--text-primary);
            margin-bottom: 30px;
            letter-spacing: 4px;
        }

        .payment-methods {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 30px 0;
        }

        .payment-method {
            padding: 30px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease;
        }

        .payment-method:hover {
            background: var(--text-primary);
        }

        .payment-method:hover h4 {
            color: var(--bg-primary);
        }

        .payment-method.selected {
            background: var(--text-primary);
        }

        .payment-method.selected h4 {
            color: var(--bg-primary);
        }

        .payment-method h4 {
            font-size: 12px;
            color: var(--text-primary);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        input {
            width: 100%;
            padding: 15px;
            margin: 15px 0;
            border: 1px solid var(--border);
            font-size: 14px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-family: 'Montserrat', sans-serif;
        }

        input:focus {
            outline: none;
            border-color: var(--text-primary);
        }

        /* Kitchen Orders */
        .kitchen-orders {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }

        .kitchen-order {
            background: var(--bg-secondary);
            padding: 25px;
            border: 1px solid var(--border);
            border-left: 3px solid var(--text-primary);
        }

        .kitchen-order.completed {
            opacity: 0.5;
            border-left-color: var(--text-secondary);
        }

        .kitchen-order h3 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 20px;
            color: var(--text-primary);
            margin-bottom: 15px;
            letter-spacing: 2px;
        }

        .kitchen-order ul {
            list-style: none;
            margin: 20px 0;
        }

        .kitchen-order li {
            padding: 8px 0;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border);
            font-size: 12px;
        }

        .order-time {
            color: var(--text-secondary);
            font-size: 10px;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .manage-section {
            background: var(--bg-secondary);
            padding: 25px;
            border: 1px solid var(--border);
            margin-top: 20px;
        }

        .menu-edit-item {
            display: grid;
            grid-template-columns: 2fr 1fr auto;
            gap: 10px;
            align-items: center;
            padding: 15px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            margin-bottom: 10px;
        }

        .menu-edit-item input {
            margin: 0;
            padding: 10px;
            font-size: 12px;
        }

        /* Animations */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        @media (max-width: 1024px) {
            .cashier-layout {
                grid-template-columns: 1fr;
            }
            
            .order-panel {
                position: static;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-container">
            <div class="login-title">POS SYSTEM</div>
            <div class="login-subtitle">Enter PIN</div>
            <div id="pinDisplay" class="pin-display"></div>
            <div class="numpad">
                <button class="numpad-btn" onclick="app.addPin('1')">1</button>
                <button class="numpad-btn" onclick="app.addPin('2')">2</button>
                <button class="numpad-btn" onclick="app.addPin('3')">3</button>
                <button class="numpad-btn" onclick="app.addPin('4')">4</button>
                <button class="numpad-btn" onclick="app.addPin('5')">5</button>
                <button class="numpad-btn" onclick="app.addPin('6')">6</button>
                <button class="numpad-btn" onclick="app.addPin('7')">7</button>
                <button class="numpad-btn" onclick="app.addPin('8')">8</button>
                <button class="numpad-btn" onclick="app.addPin('9')">9</button>
                <button class="numpad-btn" onclick="app.clearPin()">CLR</button>
                <button class="numpad-btn" onclick="app.addPin('0')">0</button>
                <button class="numpad-btn" onclick="app.checkPin()">OK</button>
            </div>
        </div>
    </div>

    <div class="container" id="mainApp" style="display: none;">
        <div class="header">
            <div class="logo">POS SYSTEM</div>
            <div class="mode-selector">
                <button class="mode-btn active" onclick="app.switchMode('cashier', event)">Cashier</button>
                <button class="mode-btn" onclick="app.switchMode('kitchen', event)">Kitchen</button>
                <button class="mode-btn" onclick="app.switchMode('history', event)">History</button>
            </div>
            <button class="logout-btn" onclick="app.logout()">Logout</button>
        </div>

        <!-- Cashier Panel -->
        <div id="cashier" class="panel active">
            <div class="stats">
                <div class="stat-card">
                    <h3>Orders</h3>
                    <div class="value" id="shiftOrders">0</div>
                </div>
                <div class="stat-card">
                    <h3>Sales</h3>
                    <div class="value" id="shiftSales">RM 0</div>
                </div>
            </div>

            <div class="cashier-layout">
                <div>
                    <div class="menu-section">
                        <div class="section-title">Menu</div>
                        <div class="menu-grid" id="menuGrid"></div>
                    </div>

                    <div class="manage-section">
                        <div class="section-title">Manage</div>
                        <div id="menuEditor"></div>
                        <button class="action-btn" onclick="app.addNewItem()">Add Item</button>
                    </div>
                </div>

                <div class="order-panel">
                    <div class="section-title">Order</div>
                    <div class="order-items" id="currentOrder"></div>
                    <div class="total-section">
                        <div class="total-label">Total</div>
                        <div class="total-amount">RM <span id="orderTotal">0</span></div>
                    </div>
                    <button class="action-btn btn-primary" onclick="app.openPaymentModal()">Payment</button>
                    <button class="action-btn" onclick="app.clearOrder()">Clear</button>
                    <button class="action-btn" onclick="app.closeShift()">Close Shift</button>
                </div>
            </div>
        </div>

        <!-- Kitchen Panel -->
        <div id="kitchen" class="panel">
            <div class="menu-section">
                <div class="section-title">Orders</div>
                <div class="kitchen-orders" id="kitchenOrders"></div>
            </div>
        </div>

        <!-- History Panel -->
        <div id="history" class="panel">
            <div class="menu-section">
                <div class="section-title">Order History</div>
                <div id="orderHistory"></div>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <h3>Payment</h3>
            <div class="total-section">
                <div class="total-label">Total</div>
                <div class="total-amount">RM <span id="paymentTotal">0</span></div>
            </div>
            
            <div class="payment-methods">
                <div class="payment-method" onclick="app.selectPaymentMethod('qr', event)">
                    <h4>QR</h4>
                </div>
                <div class="payment-method" onclick="app.selectPaymentMethod('cash', event)">
                    <h4>Cash</h4>
                </div>
            </div>

            <div id="cashPayment" style="display: none;">
                <input type="number" id="amountReceived" placeholder="Amount Received" oninput="app.calculateChange()">
                <div class="total-section">
                    <div class="total-label">Change</div>
                    <div class="total-amount">RM <span id="changeAmount">0</span></div>
                </div>
            </div>

            <button class="action-btn btn-primary" onclick="app.completePayment()">Complete</button>
            <button class="action-btn" onclick="app.closePaymentModal()">Cancel</button>
        </div>
    </div>

    <script>
        const app = {
            correctPin: '020305',
            enteredPin: '',
            isLoggedIn: false,
            
            menuItems: [],
            currentOrder: [],
            kitchenOrders: [],
            completedOrders: [],
            currentShift: { orders: [], sales: 0, startTime: null },
            allShifts: [],
            selectedPaymentMethod: null,

            async init() {
                await this.loadData();
                this.renderMenu();
                this.renderMenuEditor();
                this.updateStats();
                if (!this.currentShift.startTime) {
                    this.currentShift.startTime = new Date().toISOString();
                    await this.saveData();
                }
            },

            async loadData() {
                try {
                    // Load menu items
                    const menuResult = await window.storage.get('pos-menu');
                    if (menuResult) {
                        this.menuItems = JSON.parse(menuResult.value);
                    } else {
                        // Default menu
                        this.menuItems = [
                            { id: 1, name: 'Nasi Goreng Beef', price: 9.00 },
                            { id: 2, name: 'Nasi Goreng Ayam', price: 8.50 },
                            { id: 3, name: 'Orange Mocktail - Medium', price: 3.00 },
                            { id: 4, name: 'Orange Mocktail - Large', price: 5.00 },
                            { id: 5, name: 'Red Velvet', price: 5.50 },
                            { id: 6, name: 'Matcha', price: 6.00 },
                            { id: 7, name: 'Classico - Original Chocolate Chip', price: 5.00 },
                            { id: 8, name: 'Combo - All flavours + Cold Iced Milk', price: 15.50 },
                            { id: 9, name: 'Milk', price: 2.00 }
                        ];
                        await this.saveData();
                    }

                    // Load current shift
                    const shiftResult = await window.storage.get('pos-current-shift');
                    if (shiftResult) {
                        this.currentShift = JSON.parse(shiftResult.value);
                    }

                    // Load kitchen orders
                    const kitchenResult = await window.storage.get('pos-kitchen-orders');
                    if (kitchenResult) {
                        this.kitchenOrders = JSON.parse(kitchenResult.value);
                    }

                    // Load all shifts
                    const shiftsResult = await window.storage.get('pos-all-shifts');
                    if (shiftsResult) {
                        this.allShifts = JSON.parse(shiftsResult.value);
                    }

                    // Load completed orders
                    const completedResult = await window.storage.get('pos-completed-orders');
                    if (completedResult) {
                        this.completedOrders = JSON.parse(completedResult.value);
                    }
                } catch (error) {
                    console.error('Error loading data:', error);
                }
            },

            async saveData() {
                try {
                    await window.storage.set('pos-menu', JSON.stringify(this.menuItems));
                    await window.storage.set('pos-current-shift', JSON.stringify(this.currentShift));
                    await window.storage.set('pos-kitchen-orders', JSON.stringify(this.kitchenOrders));
                    await window.storage.set('pos-all-shifts', JSON.stringify(this.allShifts));
                    await window.storage.set('pos-completed-orders', JSON.stringify(this.completedOrders));
                } catch (error) {
                    console.error('Error saving data:', error);
                }
            },

            addPin(digit) {
                if (this.enteredPin.length < 6) {
                    this.enteredPin += digit;
                    this.updatePinDisplay();
                    this.playSound('click');
                }
            },

            clearPin() {
                this.enteredPin = '';
                this.updatePinDisplay();
                document.getElementById('pinDisplay').classList.remove('error');
                this.playSound('click');
            },

            updatePinDisplay() {
                const display = document.getElementById('pinDisplay');
                display.textContent = 'â€¢'.repeat(this.enteredPin.length);
            },

            checkPin() {
                if (this.enteredPin === this.correctPin) {
                    this.isLoggedIn = true;
                    this.playSound('success');
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('mainApp').style.display = 'block';
                    this.init();
                } else {
                    this.playSound('error');
                    document.getElementById('pinDisplay').classList.add('error');
                    setTimeout(() => {
                        this.clearPin();
                    }, 500);
                }
            },

            logout() {
                this.isLoggedIn = false;
                this.enteredPin = '';
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('mainApp').style.display = 'none';
                this.updatePinDisplay();
                this.playSound('click');
            },

            playSound(type) {
                const sounds = {
                    click: [300, 0.05],
                    success: [600, 0.1],
                    error: [200, 0.2],
                    order: [500, 0.1]
                };
                
                const [frequency, duration] = sounds[type] || [400, 0.05];
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            },

            switchMode(mode, event) {
                document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.panel').forEach(panel => panel.classList.remove('active'));
                
                event.target.classList.add('active');
                document.getElementById(mode).classList.add('active');

                if (mode === 'kitchen') {
                    this.renderKitchenOrders();
                } else if (mode === 'history') {
                    this.renderHistory();
                }
                this.playSound('click');
            },

            renderMenu() {
                const grid = document.getElementById('menuGrid');
                grid.innerHTML = this.menuItems.map(item => `
                    <div class="menu-item" onclick="app.addToOrder(${item.id})">
                        <h3>${item.name}</h3>
                        <div class="price">RM ${item.price.toFixed(2)}</div>
                    </div>
                `).join('');
            },

            renderMenuEditor() {
                const editor = document.getElementById('menuEditor');
                editor.innerHTML = this.menuItems.map(item => `
                    <div class="menu-edit-item">
                        <input type="text" value="${item.name}" onchange="app.updateItemName(${item.id}, this.value)">
                        <input type="number" step="0.01" value="${item.price}" onchange="app.updateItemPrice(${item.id}, this.value)">
                        <button class="remove-btn" onclick="app.deleteItem(${item.id})">Delete</button>
                    </div>
                `).join('');
            },

            addToOrder(itemId) {
                const item = this.menuItems.find(i => i.id === itemId);
                if (item) {
                    this.currentOrder.push({...item});
                    this.renderCurrentOrder();
                    this.playSound('order');
                }
            },

            renderCurrentOrder() {
                const orderDiv = document.getElementById('currentOrder');
                const total = this.currentOrder.reduce((sum, item) => sum + item.price, 0);

                if (this.currentOrder.length === 0) {
                    orderDiv.innerHTML = '<div class="empty-state">No items</div>';
                } else {
                    orderDiv.innerHTML = this.currentOrder.map((item, index) => `
                        <div class="order-item">
                            <div class="order-item-info">
                                <h4>${item.name}</h4>
                                <div class="item-price">RM ${item.price.toFixed(2)}</div>
                            </div>
                            <button class="remove-btn" onclick="app.removeFromOrder(${index})">Remove</button>
                        </div>
                    `).join('');
                }

                document.getElementById('orderTotal').textContent = total.toFixed(2);
            },

            removeFromOrder(index) {
                this.currentOrder.splice(index, 1);
                this.renderCurrentOrder();
                this.playSound('click');
            },

            clearOrder() {
                this.currentOrder = [];
                this.renderCurrentOrder();
                this.playSound('click');
            },

            openPaymentModal() {
                if (this.currentOrder.length === 0) {
                    alert('No items in order');
                    return;
                }

                const total = this.currentOrder.reduce((sum, item) => sum + item.price, 0);
                document.getElementById('paymentTotal').textContent = total.toFixed(2);
                document.getElementById('paymentModal').classList.add('active');
                this.playSound('click');
            },

            closePaymentModal() {
                document.getElementById('paymentModal').classList.remove('active');
                document.getElementById('cashPayment').style.display = 'none';
                document.getElementById('amountReceived').value = '';
                document.getElementById('changeAmount').textContent = '0';
                this.selectedPaymentMethod = null;
                document.querySelectorAll('.payment-method').forEach(el => el.classList.remove('selected'));
                this.playSound('click');
            },

            selectPaymentMethod(method, event) {
                this.selectedPaymentMethod = method;
                document.querySelectorAll('.payment-method').forEach(el => el.classList.remove('selected'));
                event.target.closest('.payment-method').classList.add('selected');

                if (method === 'cash') {
                    document.getElementById('cashPayment').style.display = 'block';
                } else {
                    document.getElementById('cashPayment').style.display = 'none';
                }
                this.playSound('click');
            },

            calculateChange() {
                const total = this.currentOrder.reduce((sum, item) => sum + item.price, 0);
                const received = parseFloat(document.getElementById('amountReceived').value) || 0;
                const change = received - total;
                document.getElementById('changeAmount').textContent = change >= 0 ? change.toFixed(2) : '0';
            },

            async completePayment() {
                if (!this.selectedPaymentMethod) {
                    alert('Select payment method');
                    return;
                }

                if (this.selectedPaymentMethod === 'cash') {
                    const total = this.currentOrder.reduce((sum, item) => sum + item.price, 0);
                    const received = parseFloat(document.getElementById('amountReceived').value) || 0;
                    if (received < total) {
                        alert('Insufficient amount');
                        return;
                    }
                }

                const order = {
                    id: Date.now(),
                    items: [...this.currentOrder],
                    total: this.currentOrder.reduce((sum, item) => sum + item.price, 0),
                    paymentMethod: this.selectedPaymentMethod,
                    timestamp: new Date().toISOString(),
                    displayTime: new Date().toLocaleString(),
                    status: 'pending'
                };

                this.kitchenOrders.push(order);
                this.completedOrders.push(order);
                this.currentShift.orders.push(order);
                this.currentShift.sales += order.total;

                await this.saveData();

                this.currentOrder = [];
                this.renderCurrentOrder();
                this.closePaymentModal();
                this.updateStats();
                this.playSound('success');
            },

            updateStats() {
                document.getElementById('shiftOrders').textContent = this.currentShift.orders.length;
                document.getElementById('shiftSales').textContent = `RM ${this.currentShift.sales.toFixed(2)}`;
            },

            async closeShift() {
                if (this.currentShift.orders.length === 0) {
                    alert('No orders in shift');
                    return;
                }

                const shiftData = {
                    ...this.currentShift,
                    closedAt: new Date().toISOString(),
                    displayClosedAt: new Date().toLocaleString()
                };

                this.allShifts.push(shiftData);
                await this.saveData();

                const dataStr = JSON.stringify(shiftData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `shift_${Date.now()}.json`;
                link.click();

                this.currentShift = { orders: [], sales: 0, startTime: new Date().toISOString() };
                await this.saveData();
                this.updateStats();
                this.playSound('success');
            },

            renderKitchenOrders() {
                const ordersDiv = document.getElementById('kitchenOrders');
                const pendingOrders = this.kitchenOrders.filter(o => o.status === 'pending');
                
                if (pendingOrders.length === 0) {
                    ordersDiv.innerHTML = '<div class="empty-state">No pending orders</div>';
                    return;
                }
                
                ordersDiv.innerHTML = pendingOrders.map(order => `
                    <div class="kitchen-order">
                        <h3>Order #${order.id}</h3>
                        <div class="order-time">${order.displayTime}</div>
                        <ul>
                            ${order.items.map(item => `<li>${item.name} - RM ${item.price.toFixed(2)}</li>`).join('')}
                        </ul>
                        <div style="margin-top: 15px; font-family: 'Bebas Neue', sans-serif; font-size: 20px;">TOTAL: RM ${order.total.toFixed(2)}</div>
                        <button class="action-btn" style="margin-top: 15px;" onclick="app.completeKitchenOrder(${order.id})">Done</button>
                    </div>
                `).join('');
            },

            async completeKitchenOrder(orderId) {
                const order = this.kitchenOrders.find(o => o.id === orderId);
                if (order) {
                    order.status = 'completed';
                    order.completedAt = new Date().toISOString();
                    await this.saveData();
                    this.renderKitchenOrders();
                    this.playSound('success');
                }
            },

            renderHistory() {
                const historyDiv = document.getElementById('orderHistory');
                
                if (this.completedOrders.length === 0) {
                    historyDiv.innerHTML = '<div class="empty-state">No order history</div>';
                    return;
                }

                const sortedOrders = [...this.completedOrders].reverse();
                
                historyDiv.innerHTML = sortedOrders.map(order => `
                    <div class="kitchen-order ${order.status === 'completed' ? 'completed' : ''}">
                        <h3>Order #${order.id}</h3>
                        <div class="order-time">${order.displayTime} - ${order.paymentMethod.toUpperCase()}</div>
                        <ul>
                            ${order.items.map(item => `<li>${item.name} - RM ${item.price.toFixed(2)}</li>`).join('')}
                        </ul>
                        <div style="margin-top: 15px; font-family: 'Bebas Neue', sans-serif; font-size: 20px;">TOTAL: RM ${order.total.toFixed(2)}</div>
                        <div style="margin-top: 10px; text-align: center; color: var(--text-secondary); font-size: 10px; letter-spacing: 2px;">
                            ${order.status === 'completed' ? 'COMPLETED' : 'PENDING'}
                        </div>
                    </div>
                `).join('');
            },

            async updateItemName(itemId, newName) {
                const item = this.menuItems.find(i => i.id === itemId);
                if (item) {
                    item.name = newName;
                    await this.saveData();
                    this.renderMenu();
                }
            },

            async updateItemPrice(itemId, newPrice) {
                const item = this.menuItems.find(i => i.id === itemId);
                if (item) {
                    item.price = parseFloat(newPrice);
                    await this.saveData();
                    this.renderMenu();
                }
            },

            async deleteItem(itemId) {
                if (confirm('Delete this item?')) {
                    this.menuItems = this.menuItems.filter(i => i.id !== itemId);
                    await this.saveData();
                    this.renderMenu();
                    this.renderMenuEditor();
                    this.playSound('click');
                }
            },

            async addNewItem() {
                const name = prompt('Item name:');
                const price = parseFloat(prompt('Item price:'));
                
                if (name && !isNaN(price)) {
                    const newItem = {
                        id: Math.max(...this.menuItems.map(i => i.id), 0) + 1,
                        name: name,
                        price: price
                    };
                    this.menuItems.push(newItem);
                    await this.saveData();
                    this.renderMenu();
                    this.renderMenuEditor();
                    this.playSound('success');
                }
            }
        };

        app.updatePinDisplay();
    </script>
</body>
</html>