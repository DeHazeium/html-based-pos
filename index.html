<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HzePOS System</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #141414;
            --bg-tertiary: #1e1e1e;
            --text-primary: #ffffff;
            --text-secondary: #888888;
            --border: #2a2a2a;
            --accent: #00ff88;
            --warning: #ff6b6b;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 9999;
        }

        .login-screen.hidden {
            display: none;
        }

        .login-container {
            background: var(--bg-secondary);
            padding: 50px;
            border-radius: 4px;
            border: 1px solid var(--border);
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 255, 136, 0.1);
        }

        .login-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 36px;
            color: var(--text-primary);
            margin-bottom: 8px;
            letter-spacing: 6px;
        }

        .login-subtitle {
            color: var(--text-secondary);
            margin-bottom: 40px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .pin-display {
            background: var(--bg-tertiary);
            padding: 25px;
            border-radius: 2px;
            margin-bottom: 30px;
            font-size: 32px;
            letter-spacing: 16px;
            min-height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--border);
            font-family: 'Bebas Neue', sans-serif;
        }

        .pin-display.error {
            border-color: var(--warning);
            animation: shake 0.3s ease;
        }

        .numpad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .numpad-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            padding: 0;
            height: 70px;
            width: 100%;
            border-radius: 2px;
            color: var(--text-primary);
            font-size: 24px;
            font-weight: 300;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Montserrat', sans-serif;
        }

        .numpad-btn:hover {
            background: var(--bg-primary);
            border-color: var(--text-primary);
        }

        .numpad-btn:active {
            background: var(--text-primary);
            color: var(--bg-primary);
        }

        .container {
            max-width: 100%;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            flex-wrap: wrap;
            gap: 15px;
            border-radius: 4px;
        }

        .logo {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 24px;
            color: var(--text-primary);
            letter-spacing: 4px;
        }

        .sync-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 10px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent);
            animation: pulse 2s infinite;
        }

        .sync-dot.disconnected {
            background: var(--warning);
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .mode-selector {
            display: flex;
            gap: 0;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
        }

        .mode-btn {
            padding: 12px 30px;
            font-size: 11px;
            font-weight: 500;
            border: none;
            border-right: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s ease;
            background: transparent;
            color: var(--text-secondary);
            font-family: 'Montserrat', sans-serif;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .mode-btn:last-child {
            border-right: none;
        }

        .mode-btn.active {
            background: var(--text-primary);
            color: var(--bg-primary);
        }

        .main-layout {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            min-height: calc(100vh - 200px);
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }

        .menu-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            padding: 25px;
            padding-right: 120px; /* More space for stock badge */
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }

        .menu-item-content {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
            position: relative;
            z-index: 1;
        }

        .menu-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 255, 136, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .menu-item:hover::before {
            left: 100%;
        }

        .menu-item:hover {
            border-color: var(--accent);
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0, 255, 136, 0.2);
        }

        .menu-item:active {
            transform: translateY(-1px);
        }

        .menu-item h3 {
            font-size: 18px;
            font-weight: 500;
            letter-spacing: 0.5px;
            text-align: left;
            margin: 0;
            color: var(--text-primary);
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: none;
            line-height: 1.3;
            width: 100%;
            word-break: keep-all;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .price {
            color: var(--accent);
            font-size: 20px;
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 2px;
            font-weight: 600;
            white-space: nowrap;
            flex-shrink: 0;
            text-align: right;
        }

        .category-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .category-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            padding: 12px 24px;
            color: var(--text-primary);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-family: 'Montserrat', sans-serif;
            border-radius: 4px;
        }

        .category-btn:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .category-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--bg-primary);
        }

        .order-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            padding: 25px;
            display: flex;
            flex-direction: column;
            border-radius: 4px;
        }

        .order-items {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border);
        }

        .item-details h4 {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .item-price {
            color: var(--text-secondary);
            font-size: 12px;
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 1px;
        }

        .remove-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 8px 12px;
            cursor: pointer;
            font-size: 10px;
            letter-spacing: 1px;
            text-transform: uppercase;
            transition: all 0.2s ease;
            font-family: 'Montserrat', sans-serif;
        }

        .remove-btn:hover {
            border-color: var(--warning);
            color: var(--warning);
        }

        .order-total {
            border-top: 2px solid var(--border);
            padding-top: 20px;
            margin-bottom: 20px;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
        }

        .final-total {
            display: flex;
            justify-content: space-between;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 32px;
            letter-spacing: 2px;
            margin-bottom: 25px;
        }

        .payment-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .payment-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            padding: 18px;
            color: var(--text-primary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 3px;
            font-family: 'Montserrat', sans-serif;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }

        .payment-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: var(--accent);
            transform: translate(-50%, -50%);
            transition: width 0.6s ease, height 0.6s ease;
        }

        .payment-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .payment-btn:hover {
            border-color: var(--accent);
            color: var(--bg-primary);
        }

        .payment-btn span {
            position: relative;
            z-index: 1;
        }

        .payment-btn.clear {
            border-color: var(--warning);
            color: var(--warning);
        }

        .payment-btn.clear:hover {
            background: var(--warning);
            color: var(--text-primary);
        }

        .kitchen-view {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .kitchen-order {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            padding: 25px;
            position: relative;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .kitchen-order:hover {
            border-color: var(--accent);
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0, 255, 136, 0.15);
        }

        .kitchen-order.completed {
            opacity: 0.6;
            border-color: var(--accent);
        }

        .kitchen-order.preorder {
            border-left: 4px solid var(--accent);
        }

        .kitchen-order h3 {
            font-size: 20px;
            margin-bottom: 10px;
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 2px;
            color: var(--text-primary);
        }

        .order-time {
            color: var(--text-secondary);
            font-size: 11px;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .order-notes {
            background: var(--bg-tertiary);
            padding: 15px;
            margin-bottom: 20px;
            border-left: 3px solid var(--accent);
            font-size: 13px;
            color: var(--text-primary);
            font-style: italic;
            border-radius: 2px;
        }

        .order-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--accent);
            color: var(--bg-primary);
            padding: 8px 14px;
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 2px;
            text-transform: uppercase;
            border-radius: 2px;
        }

        .order-badge.preorder {
            background: var(--accent);
        }

        .kitchen-order ul {
            list-style: none;
            margin-bottom: 20px;
            background: var(--bg-tertiary);
            padding: 15px;
            border-radius: 4px;
        }

        .kitchen-order li {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }

        .kitchen-order li:last-child {
            border-bottom: none;
        }

        .kitchen-order li strong {
            color: var(--accent);
            font-weight: 700;
        }

        .action-btn {
            width: 100%;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            padding: 16px;
            color: var(--text-primary);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-family: 'Montserrat', sans-serif;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }

        .action-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: var(--accent);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1), height 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .action-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .action-btn:hover {
            border-color: var(--accent);
            color: var(--bg-primary);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 255, 136, 0.3);
        }

        .action-btn:active {
            transform: translateY(0px);
        }

        .action-btn span {
            position: relative;
            z-index: 1;
        }

        .empty-state {
            grid-column: 1 / -1;
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .hidden {
            display: none !important;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            transition: background 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .modal.active {
            display: flex;
            background: rgba(0, 0, 0, 0.9);
            animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes fadeIn {
            from {
                background: rgba(0, 0, 0, 0);
            }
            to {
                background: rgba(0, 0, 0, 0.9);
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            padding: 40px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .modal-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 28px;
            letter-spacing: 3px;
        }

        .close-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 10px 15px;
            cursor: pointer;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: all 0.2s ease;
            font-family: 'Montserrat', sans-serif;
        }

        .close-btn:hover {
            border-color: var(--text-primary);
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--text-secondary);
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            padding: 15px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: 'Montserrat', sans-serif;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .submit-btn {
            width: 100%;
            background: var(--accent);
            border: none;
            padding: 18px;
            color: var(--bg-primary);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 3px;
            transition: all 0.2s ease;
            font-family: 'Montserrat', sans-serif;
        }

        .submit-btn:hover {
            background: var(--text-primary);
        }

        .report-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .report-stat {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            padding: 25px;
            text-align: center;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 12px;
        }

        .stat-value {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 36px;
            letter-spacing: 2px;
            color: var(--accent);
        }

        .items-sold-list {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            padding: 25px;
        }

        .items-sold-list h4 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 20px;
            letter-spacing: 2px;
            margin-bottom: 20px;
        }

        .sold-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
        }

        .sold-item-count {
            color: var(--text-secondary);
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 1px;
        }

        .payment-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }

        .payment-modal.active {
            display: flex;
        }

        .payment-modal-content {
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            padding: 50px;
            max-width: 500px;
            width: 100%;
            text-align: center;
        }

        .payment-method-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 32px;
            letter-spacing: 4px;
            margin-bottom: 10px;
            color: var(--accent);
        }

        .payment-amount-display {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 48px;
            letter-spacing: 3px;
            margin: 30px 0;
            color: var(--text-primary);
        }

        .cash-input-group {
            margin: 30px 0;
        }

        .cash-input-group label {
            display: block;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--text-secondary);
            margin-bottom: 15px;
        }

        .cash-input-group input {
            width: 100%;
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            padding: 20px;
            color: var(--text-primary);
            font-size: 32px;
            font-family: 'Bebas Neue', sans-serif;
            text-align: center;
            letter-spacing: 2px;
        }

        .cash-input-group input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .change-display {
            background: var(--bg-tertiary);
            border: 2px solid var(--accent);
            padding: 25px;
            margin: 20px 0;
            font-family: 'Bebas Neue', sans-serif;
        }

        .change-label {
            font-size: 14px;
            letter-spacing: 2px;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .change-amount {
            font-size: 42px;
            letter-spacing: 3px;
            color: var(--accent);
        }

        .payment-modal-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .payment-modal-btn {
            flex: 1;
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            padding: 20px;
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 3px;
            font-family: 'Montserrat', sans-serif;
        }

        .payment-modal-btn:hover {
            transform: translateY(-2px);
        }

        .payment-modal-btn.confirm {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--bg-primary);
        }

        .payment-modal-btn.confirm:hover {
            background: var(--text-primary);
            border-color: var(--text-primary);
        }

        .payment-modal-btn.cancel {
            border-color: var(--warning);
            color: var(--warning);
        }

        .payment-modal-btn.cancel:hover {
            background: var(--warning);
            color: var(--text-primary);
        }

        .insufficient-cash {
            color: var(--warning);
            font-size: 12px;
            margin-top: 10px;
            letter-spacing: 2px;
        }

        .footer {
            text-align: center;
            padding: 30px 20px;
            margin-top: 50px;
            border-top: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 11px;
            letter-spacing: 1px;
        }

        .footer-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .footer-ig {
            color: var(--accent);
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .footer-ig:hover {
            color: var(--text-primary);
        }

        .shift-history-list {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .shift-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .shift-card:hover {
            border-color: var(--accent);
            transform: translateX(5px);
        }

        .shift-card-date {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 18px;
            letter-spacing: 2px;
            margin-bottom: 10px;
        }

        .shift-card-stats {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Toggle Switch */
        #stockToggle:checked + span {
            background-color: var(--accent);
            border-color: var(--accent);
        }

        #stockToggle:checked + span + span {
            transform: translateX(30px);
            background-color: var(--bg-primary);
        }

        #stockToggle:checked + span + span + span {
            opacity: 0;
        }

        #stockToggle:checked + span + span + span + span {
            opacity: 1;
        }

        .stock-item-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            margin-bottom: 15px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .stock-item-row:hover {
            border-color: var(--accent);
            transform: translateX(3px);
        }

        .preorder-payment-btn:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 255, 136, 0.2);
        }

        .preorder-payment-btn.selected {
            background: var(--accent) !important;
            border-color: var(--accent) !important;
            color: var(--bg-primary) !important;
        }

        .preorder-payment-btn.selected .check-mark {
            opacity: 1 !important;
        }

        .stock-item-info {
            flex: 1;
        }

        .stock-item-name {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .stock-item-price {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .stock-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stock-input {
            width: 80px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            padding: 8px;
            color: var(--text-primary);
            font-size: 14px;
            text-align: center;
            font-family: 'Montserrat', sans-serif;
        }

        .stock-badge {
            padding: 4px 12px;
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
            border-radius: 2px;
        }

        .stock-badge.low {
            background: var(--warning);
            color: var(--text-primary);
        }

        .stock-badge.ok {
            background: var(--accent);
            color: var(--bg-primary);
        }

        .stock-badge.out {
            background: var(--bg-primary);
            color: var(--warning);
            border: 1px solid var(--warning);
        }

        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
            }

            .menu-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
            }

            .mode-selector {
                flex-direction: column;
                width: 100%;
            }

            .mode-btn {
                border-right: none;
                border-bottom: 1px solid var(--border);
            }

            .kitchen-view {
                grid-template-columns: 1fr;
            }
        }
        /* Toast Notification System */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .toast {
            background: var(--bg-secondary);
            border: 1px solid var(--accent);
            border-radius: 4px;
            padding: 20px 25px;
            min-width: 300px;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5), 0 0 20px rgba(0, 255, 136, 0.3);
            display: flex;
            align-items: center;
            gap: 0px;
            pointer-events: auto;
            animation: slideInRight 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .toast.exit {
            animation: slideOutRight 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        .toast::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: var(--accent);
            animation: progressBar 3s linear forwards;
        }

        @keyframes progressBar {
            from {
                width: 100%;
            }
            to {
                width: 0%;
            }
        }

        .toast-icon {
            font-size: 28px;
            line-height: 1;
            flex-shrink: 0;
            display: none; /* Hide icon since it's empty */
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 16px;
            letter-spacing: 2px;
            color: var(--accent);
            margin-bottom: 5px;
        }

        .toast-message {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .toast-close {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 20px;
            padding: 5px;
            line-height: 1;
            transition: color 0.2s;
            margin-left: 15px;
        }

        .toast-close:hover {
            color: var(--text-primary);
        }

        .toast.success {
            border-color: var(--accent);
        }

        .toast.warning {
            border-color: var(--warning);
        }

        .toast.warning .toast-title {
            color: var(--warning);
        }

        .toast.warning .toast-message {
            color: var(--text-primary); /* White text for better contrast */
        }

        .toast.warning::before {
            background: var(--warning);
        }

        .toast.info {
            border-color: #3b82f6;
        }

        .toast.info .toast-title {
            color: #3b82f6;
        }

        .toast.info::before {
            background: #3b82f6;
        }
    </style>
</head>
<body>
    <!-- Toast Notification Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-container">
            <div class="login-title">HZEPOS</div>
            <div class="login-subtitle">Enter PIN to Continue</div>
            <div id="pinDisplay" class="pin-display"></div>
            <div class="numpad">
                <button class="numpad-btn" onclick="app.addPin('1')">1</button>
                <button class="numpad-btn" onclick="app.addPin('2')">2</button>
                <button class="numpad-btn" onclick="app.addPin('3')">3</button>
                <button class="numpad-btn" onclick="app.addPin('4')">4</button>
                <button class="numpad-btn" onclick="app.addPin('5')">5</button>
                <button class="numpad-btn" onclick="app.addPin('6')">6</button>
                <button class="numpad-btn" onclick="app.addPin('7')">7</button>
                <button class="numpad-btn" onclick="app.addPin('8')">8</button>
                <button class="numpad-btn" onclick="app.addPin('9')">9</button>
                <button class="numpad-btn" onclick="app.clearPin()">CLR</button>
                <button class="numpad-btn" onclick="app.addPin('0')">0</button>
                <button class="numpad-btn" onclick="app.checkPin()">OK</button>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="container hidden">
        <div class="header">
            <div class="logo">HZEPOS</div>
            <div class="sync-indicator">
                <div id="syncDot" class="sync-dot"></div>
                <span id="syncStatus">SYNCED</span>
            </div>
            <div class="mode-selector">
                <button class="mode-btn active" data-mode="pos" onclick="app.switchMode('pos')">POS</button>
                <button class="mode-btn" data-mode="kitchen" onclick="app.switchMode('kitchen')">KITCHEN</button>
                <button class="mode-btn" data-mode="pickup" onclick="app.switchMode('pickup')">PICKUP</button>
                <button class="mode-btn" data-mode="preorder" onclick="app.switchMode('preorder')">PREORDER</button>
                <button class="mode-btn" data-mode="history" onclick="app.switchMode('history')">HISTORY</button>
                <button class="mode-btn" data-mode="stock" onclick="app.openStockManager()">STOCK</button>
                <button class="mode-btn" data-mode="report" onclick="app.openShiftReport()">REPORT</button>
            </div>
        </div>

        <!-- POS Mode -->
        <div id="posMode" class="main-layout">
            <div style="width: 100%;">
                <div class="category-filter">
                    <button class="category-btn active" onclick="app.filterCategory('all')">ALL</button>
                    <button class="category-btn" onclick="app.filterCategory('rice')">RICE</button>
                    <button class="category-btn" onclick="app.filterCategory('beverages')">BEVERAGES</button>
                    <button class="category-btn" onclick="app.filterCategory('cookies')">COOKIES</button>
                </div>
                <div class="menu-grid" id="menuGrid"></div>
            </div>
            <div class="order-panel">
                <h2 style="font-family: 'Bebas Neue', sans-serif; font-size: 24px; letter-spacing: 3px; margin-bottom: 25px;">CURRENT ORDER</h2>
                <div class="order-items" id="orderItems">
                    <div class="empty-state">No items added</div>
                </div>
                <div class="order-total">
                    <div class="total-row">
                        <span>Subtotal</span>
                        <span id="subtotal">RM 0.00</span>
                    </div>
                    <div class="final-total">
                        <span>TOTAL</span>
                        <span id="totalAmount">RM 0.00</span>
                    </div>
                </div>
                <div class="payment-buttons">
                    <button class="payment-btn" onclick="app.processPayment('cash')"><span>CASH PAYMENT</span></button>
                    <button class="payment-btn" onclick="app.processPayment('card')"><span>CARD PAYMENT</span></button>
                    <button class="payment-btn" onclick="app.processPayment('ewallet')"><span>E-WALLET</span></button>
                    <button class="payment-btn clear" onclick="app.clearOrder()"><span>CLEAR ORDER</span></button>
                </div>
            </div>
        </div>

        <!-- Kitchen Mode -->
        <div id="kitchenMode" class="kitchen-view hidden"></div>

        <!-- Pickup Mode -->
        <div id="pickupMode" class="kitchen-view hidden"></div>

        <!-- Preorder Mode -->
        <div id="preorderMode" class="hidden">
            <button class="payment-btn" style="max-width: 300px; margin-bottom: 30px;" onclick="app.openPreorderModal()">+ NEW PREORDER</button>
            <div id="preorderList" class="kitchen-view"></div>
        </div>

        <!-- History Mode -->
        <div id="historyMode" class="kitchen-view hidden"></div>

        <!-- Footer -->
        <div class="footer">
            <div class="footer-name">Developed by Muhammad Irfan</div>
            <a href="https://instagram.com/hzetronics" target="_blank" class="footer-ig">@hzetronics</a>
        </div>
    </div>

    <!-- Preorder Modal -->
    <div id="preorderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">NEW PREORDER</div>
                <button class="close-btn" onclick="app.closePreorderModal()">✕ CLOSE</button>
            </div>
            
            <div class="form-group">
                <label>Customer Name</label>
                <input type="text" id="preorderCustomer" placeholder="Enter customer name">
            </div>

            <div class="form-group">
                <label>Selected Items</label>
                <div id="preorderSelectedItems" style="background: var(--bg-tertiary); border: 1px solid var(--border); padding: 15px; min-height: 100px; max-height: 250px; overflow-y: auto;">
                    <div class="empty-state" style="padding: 20px;">No items selected</div>
                </div>
            </div>
            
            <div style="background: var(--bg-tertiary); padding: 20px; margin: 20px 0; text-align: center; border: 1px solid var(--accent);">
                <div style="font-family: 'Bebas Neue', sans-serif; font-size: 28px; letter-spacing: 2px;">
                    TOTAL: RM <span id="preorderTotal">0.00</span>
                </div>
            </div>
            
            <div class="form-group">
                <label>Add Items</label>
                <div class="menu-grid" id="preorderMenuGrid"></div>
            </div>
            
            <button class="submit-btn" onclick="app.createPreorder()">CREATE PREORDER</button>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="payment-modal">
        <div class="payment-modal-content">
            <div class="payment-method-title" id="paymentMethodTitle">CASH PAYMENT</div>
            <div class="payment-amount-display">
                TOTAL: RM <span id="paymentTotal">0.00</span>
            </div>
            
            <!-- Customer Name Input -->
            <div style="margin-bottom: 20px;">
                <label style="font-size: 12px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; display: block; margin-bottom: 8px;">Customer Name (Optional)</label>
                <input type="text" id="posCustomerName" placeholder="Enter customer name" style="width: 100%; background: var(--bg-tertiary); border: 1px solid var(--border); padding: 15px; color: var(--text-primary); font-size: 14px; font-family: 'Montserrat', sans-serif; border-radius: 4px;">
            </div>

            <div id="cashInputSection" class="cash-input-group" style="display: none;">
                <label>CASH RECEIVED</label>
                <input type="number" id="cashReceived" placeholder="0.00" step="0.01" min="0">
                <div id="insufficientWarning" class="insufficient-cash" style="display: none;">
                    ⚠ INSUFFICIENT AMOUNT
                </div>
            </div>

            <div id="changeSection" class="change-display" style="display: none;">
                <div class="change-label">CHANGE</div>
                <div class="change-amount">RM <span id="changeAmount">0.00</span></div>
            </div>

            <div class="payment-modal-buttons">
                <button class="payment-modal-btn cancel" onclick="app.cancelPayment()">CANCEL</button>
                <button class="payment-modal-btn confirm" id="confirmPaymentBtn" onclick="app.confirmPayment()">CONFIRM PAYMENT</button>
            </div>
        </div>
    </div>

    <!-- Shift Report Modal -->
    <div id="shiftReportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">SHIFT REPORT</div>
                <button class="close-btn" onclick="app.closeShiftReport()">✕ CLOSE</button>
            </div>
            <div id="shiftReportContent"></div>
            <div style="display: flex; gap: 15px; margin-top: 30px;">
                <button class="submit-btn" style="background: var(--bg-tertiary); color: var(--text-primary);" onclick="app.viewShiftHistory()">VIEW HISTORY</button>
                <button class="submit-btn" style="background: var(--bg-tertiary); color: var(--text-primary);" onclick="app.openAdminEdit()">ADMIN EDIT</button>
                <button class="submit-btn" style="background: var(--accent);" onclick="app.saveShiftReport()">SAVE REPORT</button>
                <button class="submit-btn" style="background: var(--warning);" onclick="app.clearShift()">CLEAR SHIFT</button>
            </div>
        </div>
    </div>

    <!-- Admin Edit Modal -->
    <div id="adminEditModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ADMIN EDIT - SHIFT DATA</div>
                <button class="close-btn" onclick="app.closeAdminEdit()">✕ CLOSE</button>
            </div>

            <div style="background: var(--warning); color: var(--text-primary); padding: 15px; margin-bottom: 20px; border-radius: 4px; text-align: center; font-size: 12px; font-weight: 600; letter-spacing: 1px;">
                ⚠️ WARNING: Editing these values will affect your shift report
            </div>

            <div class="form-group">
                <label>Total Sales Revenue (RM)</label>
                <input type="number" id="adminTotalSales" step="0.01" min="0" style="width: 100%; background: var(--bg-tertiary); border: 1px solid var(--border); padding: 15px; color: var(--text-primary); font-size: 18px; font-weight: 600; font-family: 'Montserrat', sans-serif;">
            </div>

            <div class="form-group">
                <label>Total Order Count</label>
                <input type="number" id="adminOrderCount" min="0" style="width: 100%; background: var(--bg-tertiary); border: 1px solid var(--border); padding: 15px; color: var(--text-primary); font-size: 18px; font-weight: 600; font-family: 'Montserrat', sans-serif;">
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div class="form-group">
                    <label>Cash Payments (RM)</label>
                    <input type="number" id="adminCash" step="0.01" min="0" style="width: 100%; background: var(--bg-tertiary); border: 1px solid var(--border); padding: 15px; color: var(--text-primary); font-size: 16px; font-family: 'Montserrat', sans-serif;">
                </div>
                <div class="form-group">
                    <label>Card Payments (RM)</label>
                    <input type="number" id="adminCard" step="0.01" min="0" style="width: 100%; background: var(--bg-tertiary); border: 1px solid var(--border); padding: 15px; color: var(--text-primary); font-size: 16px; font-family: 'Montserrat', sans-serif;">
                </div>
                <div class="form-group">
                    <label>E-Wallet Payments (RM)</label>
                    <input type="number" id="adminEwallet" step="0.01" min="0" style="width: 100%; background: var(--bg-tertiary); border: 1px solid var(--border); padding: 15px; color: var(--text-primary); font-size: 16px; font-family: 'Montserrat', sans-serif;">
                </div>
            </div>

            <div class="form-group">
                <label>Items Sold</label>
                <div id="adminItemsList" style="background: var(--bg-tertiary); border: 1px solid var(--border); padding: 20px; max-height: 300px; overflow-y: auto;"></div>
            </div>

            <div style="display: flex; gap: 15px; margin-top: 20px;">
                <button class="submit-btn" style="flex: 1; background: var(--bg-tertiary); color: var(--text-primary);" onclick="app.closeAdminEdit()">CANCEL</button>
                <button class="submit-btn" style="flex: 1;" onclick="app.saveAdminEdit()">SAVE CHANGES</button>
            </div>
        </div>
    </div>

    <!-- Preorder Payment Modal -->
    <div id="preorderPaymentModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <div class="modal-title">CONFIRM PAYMENT</div>
                <button class="close-btn" onclick="app.closePreorderPaymentModal()">✕ CLOSE</button>
            </div>

            <div style="background: var(--bg-tertiary); padding: 25px; margin-bottom: 25px; text-align: center; border-radius: 4px; border: 1px solid var(--border);">
                <div style="font-size: 12px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 10px;">Order Total</div>
                <div style="font-family: 'Bebas Neue', sans-serif; font-size: 36px; letter-spacing: 3px; color: var(--accent);">RM <span id="preorderPaymentTotal">0.00</span></div>
            </div>

            <div style="margin-bottom: 25px;">
                <div style="font-size: 12px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 15px;">Select Payment Method</div>
                <div style="display: grid; gap: 12px;">
                    <button class="preorder-payment-btn" onclick="app.selectPreorderPayment('cash')" style="background: var(--bg-tertiary); border: 2px solid var(--border); padding: 18px; color: var(--text-primary); font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 2px; font-family: 'Montserrat', sans-serif; border-radius: 4px; display: flex; align-items: center; justify-content: space-between;">
                        <span>CASH</span>
                        <span style="font-size: 20px; opacity: 0;" class="check-mark">✓</span>
                    </button>
                    <button class="preorder-payment-btn" onclick="app.selectPreorderPayment('card')" style="background: var(--bg-tertiary); border: 2px solid var(--border); padding: 18px; color: var(--text-primary); font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 2px; font-family: 'Montserrat', sans-serif; border-radius: 4px; display: flex; align-items: center; justify-content: space-between;">
                        <span>CARD</span>
                        <span style="font-size: 20px; opacity: 0;" class="check-mark">✓</span>
                    </button>
                    <button class="preorder-payment-btn" onclick="app.selectPreorderPayment('ewallet')" style="background: var(--bg-tertiary); border: 2px solid var(--border); padding: 18px; color: var(--text-primary); font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 2px; font-family: 'Montserrat', sans-serif; border-radius: 4px; display: flex; align-items: center; justify-content: space-between;">
                        <span>E-WALLET</span>
                        <span style="font-size: 20px; opacity: 0;" class="check-mark">✓</span>
                    </button>
                </div>
            </div>

            <button class="submit-btn" id="confirmPreorderPaymentBtn" onclick="app.finalizePreorderPayment()" style="opacity: 0.5; pointer-events: none;">CONFIRM PAYMENT</button>
        </div>
    </div>

    <!-- Discount Modal -->
    <div id="discountModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <div class="modal-title">APPLY DISCOUNT</div>
            </div>

            <div style="padding: 25px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 4px; margin-bottom: 25px;">
                <div id="discountItemName" style="font-size: 18px; font-weight: 600; margin-bottom: 15px; color: var(--accent);"></div>
                <div id="discountOriginalPrice" style="font-size: 14px; color: var(--text-secondary); margin-bottom: 20px;"></div>
                
                <div style="display: grid; gap: 15px;">
                    <div>
                        <label style="font-size: 12px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; display: block; margin-bottom: 8px;">Discount Type</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <button id="discountTypePercentage" class="submit-btn" style="background: var(--accent);" onclick="app.setDiscountType('percentage')">PERCENTAGE (%)</button>
                            <button id="discountTypeFixed" class="submit-btn" style="background: var(--bg-tertiary); color: var(--text-primary);" onclick="app.setDiscountType('fixed')">FIXED (RM)</button>
                        </div>
                    </div>
                    
                    <div>
                        <label style="font-size: 12px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; display: block; margin-bottom: 8px;">Discount Amount</label>
                        <input type="number" id="discountAmount" placeholder="Enter amount" min="0" style="width: 100%; background: var(--bg-primary); border: 1px solid var(--border); padding: 15px; color: var(--text-primary); font-size: 16px; font-family: 'Montserrat', sans-serif; border-radius: 4px;">
                    </div>
                    
                    <div id="discountPreview" style="padding: 15px; background: var(--bg-primary); border: 1px solid var(--accent); border-radius: 4px; text-align: center;">
                        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 5px;">NEW PRICE</div>
                        <div id="discountNewPrice" style="font-size: 24px; font-family: 'Bebas Neue', sans-serif; color: var(--accent); letter-spacing: 2px;">RM 0.00</div>
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 12px;">
                <button class="submit-btn" style="flex: 1; background: var(--bg-tertiary); color: var(--text-primary);" onclick="app.closeDiscountModal()">CANCEL</button>
                <button class="submit-btn" style="flex: 1; background: var(--accent);" onclick="app.applyDiscount()">APPLY DISCOUNT</button>
            </div>
        </div>
    </div>

    <!-- Password Modal -->
    <div id="passwordModal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <div class="modal-title" id="passwordModalTitle">ADMIN ACCESS</div>
            </div>

            <div style="margin-bottom: 25px;">
                <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 15px; line-height: 1.6;" id="passwordModalMessage">Enter admin password to continue:</div>
                <input type="password" id="passwordInput" placeholder="Enter password" style="width: 100%; background: var(--bg-tertiary); border: 2px solid var(--border); padding: 18px; color: var(--text-primary); font-size: 16px; font-family: 'Montserrat', sans-serif; border-radius: 4px; text-align: center; letter-spacing: 3px;" onkeypress="if(event.key === 'Enter') app.submitPassword()">
            </div>

            <div style="display: flex; gap: 12px;">
                <button class="submit-btn" style="flex: 1; background: var(--bg-tertiary); color: var(--text-primary);" onclick="app.cancelPassword()">CANCEL</button>
                <button class="submit-btn" style="flex: 1;" onclick="app.submitPassword()">SUBMIT</button>
            </div>
        </div>
    </div>

    <!-- Notification Modal -->
    <div id="notificationModal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <div class="modal-title" id="notificationTitle">NOTIFICATION</div>
            </div>

            <div style="background: var(--bg-tertiary); padding: 25px; margin-bottom: 25px; text-align: center; border-radius: 4px; border: 1px solid var(--border);">
                <div id="notificationIcon" style="font-size: 48px; margin-bottom: 15px;">ℹ️</div>
                <div id="notificationMessage" style="font-size: 14px; line-height: 1.6; color: var(--text-primary);"></div>
            </div>

            <button class="submit-btn" onclick="app.closeNotification()">OK</button>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <div class="modal-title">CONFIRM ACTION</div>
            </div>

            <div style="background: var(--bg-tertiary); padding: 25px; margin-bottom: 25px; text-align: center; border-radius: 4px; border: 1px solid var(--border);">
                <div style="font-size: 48px; margin-bottom: 15px;">⚠️</div>
                <div id="confirmMessage" style="font-size: 14px; line-height: 1.6; color: var(--text-primary);"></div>
            </div>

            <div style="display: flex; gap: 12px;">
                <button class="submit-btn" style="flex: 1; background: var(--bg-tertiary); color: var(--text-primary);" onclick="app.cancelConfirm()">CANCEL</button>
                <button class="submit-btn" style="flex: 1; background: var(--warning);" onclick="app.acceptConfirm()">CONFIRM</button>
            </div>
        </div>
    </div>

    <!-- Shift History Modal -->
    <div id="shiftHistoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">SHIFT HISTORY</div>
                <button class="close-btn" onclick="app.closeShiftHistory()">✕ CLOSE</button>
            </div>
            <div id="shiftHistoryContent" class="shift-history-list"></div>
        </div>
    </div>

    <!-- Stock Manager Modal -->
    <div id="stockManagerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">STOCK MANAGEMENT</div>
                <button class="close-btn" onclick="app.closeStockManager()">✕ CLOSE</button>
            </div>

            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 30px; padding: 20px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 4px;">
                <div style="flex: 1;">
                    <div style="font-size: 16px; font-weight: 600; margin-bottom: 5px;">Stock Tracking</div>
                    <div style="font-size: 11px; color: var(--text-secondary); letter-spacing: 1px;">Enable inventory management and stock limits</div>
                </div>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div id="stockStatusText" style="font-size: 14px; font-weight: 600; letter-spacing: 2px; min-width: 60px; text-align: right;"></div>
                    <label style="position: relative; display: inline-block; width: 70px; height: 40px;">
                        <input type="checkbox" id="stockToggle" onchange="app.toggleStock()" style="opacity: 0; width: 0; height: 0;">
                        <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--bg-primary); transition: .4s; border-radius: 40px; border: 2px solid var(--border);"></span>
                        <span style="position: absolute; content: ''; height: 32px; width: 32px; left: 4px; bottom: 4px; background-color: var(--text-secondary); transition: .4s; border-radius: 50%;"></span>
                        <span style="position: absolute; left: 8px; top: 50%; transform: translateY(-50%); font-size: 10px; font-weight: 700; color: var(--text-secondary); letter-spacing: 1px; pointer-events: none;">OFF</span>
                        <span style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); font-size: 10px; font-weight: 700; color: var(--bg-primary); letter-spacing: 1px; pointer-events: none; opacity: 0; transition: opacity 0.3s;">ON</span>
                    </label>
                </div>
            </div>

            <div id="stockItemsList"></div>

            <div style="margin-top: 20px; text-align: center;">
                <button class="submit-btn" onclick="app.saveStock()">SAVE CHANGES</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, push, get, onValue, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAAVcKdR82Hj2ghXcSrQfWdGJZ8UjEOQJM",
            authDomain: "pos-irfan.firebaseapp.com",
            databaseURL: "https://pos-irfan-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "pos-irfan",
            storageBucket: "pos-irfan.firebasestorage.app",
            messagingSenderId: "528217082644",
            appId: "1:528217082644:web:1c8cabfc0eb41e7c399001"
        };

        // Initialize Firebase
        try {
            const firebaseApp = initializeApp(firebaseConfig);
            const database = getDatabase(firebaseApp);

            // Expose Firebase functions to global scope
            window.db = database;
            window.dbRef = ref;
            window.dbSet = set;
            window.dbPush = push;
            window.dbGet = get;
            window.dbOnValue = onValue;
            window.dbRemove = remove;

            console.log('Firebase initialized successfully');
        } catch (error) {
            console.error('Firebase initialization error:', error);
            console.log('App will continue without Firebase...');
        }
    </script>

    <!-- Main Application Script -->
    <script>
        // Define app object FIRST
        const app = {
            pin: '',
            correctPin: '1234',
            adminPassword: '020305', // Admin password for sensitive operations
            currentMode: 'pos',
            currentOrder: [],
            stockEnabled: true, // Toggle for stock management
            currentCategory: 'all', // Current selected category
            menuItems: [
                { id: 1, name: 'Nasi Goreng Black Pepper Beef', price: 9.00, category: 'rice', inStock: true, image: '' },
                { id: 2, name: 'Plain Rice Ball', price: 4.00, category: 'rice', inStock: true, image: '' },
                { id: 3, name: 'Tuna Rice Ball', price: 6.00, category: 'rice', inStock: true, image: '' },
                { id: 4, name: 'Orange Mocktail - Medium', price: 3.00, category: 'beverages', inStock: true, image: '' },
                { id: 5, name: 'Orange Mocktail - Large', price: 5.00, category: 'beverages', inStock: true, image: '' },
                { id: 6, name: 'Milk', price: 2.00, category: 'beverages', inStock: true, image: '' },
                { id: 7, name: 'Red Velvet', price: 5.50, category: 'cookies', inStock: true, image: '' },
                { id: 8, name: 'Matcha', price: 6.00, category: 'cookies', inStock: true, image: '' },
                { id: 9, name: 'Classico - Original Chocolate Chip', price: 5.00, category: 'cookies', inStock: true, image: '' },
                { id: 10, name: 'Combo - All flavours + Cold Iced Milk', price: 15.50, category: 'cookies', inStock: true, image: '' }
            ],
            currentPaymentMethod: null,
            currentPaymentTotal: 0,
            currentPreorderId: null,
            currentPreorderKey: null,
            selectedPreorderPayment: null,
            currentDiscountItemIndex: null,
            currentDiscountType: 'percentage',
            passwordResolve: null,
            notificationResolve: null,
            confirmResolve: null,
            currentKitchenOrders: {},
            currentHistoryOrders: {},
            preorderItems: [],
            sounds: {
                click: new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZUQ0PVajl8q9fGQc+l9ryz3UmBSR3yPDcjkALFFm06+yiWBIJQ5zf8L90JQQsg8rx2Io2CBhnu+3mn1gPDVGn5O+wYx0GOpHX8sl0JwYidcbw3I9ACxVds+3rpFYVCkeY4PKxaB8FM4nU89N8LQQngsnw2Yw6CRxvwO/jm1EMDkyj5e+vZBoGPJTY8s94KQQkcsfv25FADBVbte3soFgTCUOZ3vG8cSQEL4PJ8NqLOAkes+3mnlYOEEyh5u+vaR0FO5TX8sJzKQUjdMfv1pBCDBRatO3qoVgTCUOZ3vG8cSQEL4PJ8NqLOAkes+3mnlYOEEyh5u+vaR0FO5TX8sJzKQUjdMfv1pBCDBRatO3qoVgTCUOZ3vG8cSQEL4PJ8NqLOAkes+3mnlYOEEyh5u+vaR0FO5TX8sJzKQUjdMfv1pBCDBRatO3qoVgTCUOZ3vG8cSQEL4PJ8NqLOAkes+3mnlYOEEyh5u+vaR0FO5TX8sJzKQUjdMfv1pBCDBRatO3qoVgTCUOZ3vG8cSQEL4PJ8NqLOAkes+3mnlYOEEyh5u+vaR0FO5TX8sJzKQUjdMfv1pBCDBRatO3qoVgTCUOZ3vG8cSQEL4PJ8NqLOAkes+3mnlYOEEyh5u+vaR0FO5TX8sJzKQUjdMfv1pBCDBRatO3qoVgTCUOZ3vG8cSQEL4PJ8NqLOAkes+3mnlYOEEyh5u+vaR0FO5TX8sJzKQUjdMfv1pBCDBRatO3qoVgTCUOZ3vG8cSQEL4PJ8NqLOAkes+3mnlYOEEyh5u+vaR0FO5TX8sJzKQUjdMfv1pBCDBRatO3qoVgTCUOZ3vG8cSQEL4PJ8NqLOAkes+3mnlYOEEyh5u+vaR0FO5TX8sJzKQUjdMfv1pBCDBRatO3qoVgTCUOZ3vG8cSQEL4PJ8NqLOAkes+3mnlYOEEyh5u+vaR0FO5TX8sJzKQUjdMfv1pBCDBRatO3qoVgTCUOZ3vG8cSQEL4PJ8NqLOAkes+3mnlYOEEyh5u+vaR0FO5TX8sJzKQUjdMfv1pBCDBRatO3qoVgTCUOZ3vG8cSQEL4PJ8NqLOAkes+3mnlYOEEyh5u+vaR0FO5TX8sJzKQUjdMfv'),
                order: new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZUQ0PVajl8q9fGQc+l9ryz3UmBSR3yPDcjkALFFm06+yiWBIJQ5zf8L90JQQsg8rx2Io2CBhnu+3mn1gPDVGn5O+wYx0GOpHX8sl0JwYidcbw3I9ACxVds+3rpFYVCkeY4PKxaB8FM4nU89N8LQQngsnw2Yw6CRxvwO/jm1EMDkyj5e+vZBoGPJTY8s94KQQkcsfv25FADBVbte3soFgTCUOZ3vG8cSQEL4PJ8NqLOAkes+3mnlYOEEyh5u+vaR0FO5TX8sJzKQUjdMfv1pBCDBRatO3qoVgTCUOZ3vG8cSQEL4PJ8NqLOAkes+3mnlYOEEyh5u+vaR0FO5TX8sJzKQUjdMfv1pBCDBRatO3qoVgTCUOZ3vG8cSQEL4PJ8NqLOAkes+3mnlYOEEyh5u+vaR0FO5TX8sJzKQUjdMfv1pBCDBRatO3qoVgTCUOZ3vG8cSQEL4PJ8NqLOAkes+3mnlYOEEyh5u+vaR0FO5TX8sJzKQUjdMfv1pBCDBRatO3qoVgTCUOZ3vG8cSQEL4PJ8NqLOAkes+3mnlYOEEyh5u+vaR0FO5TX8sJzKQUjdMfv1pBCDBRatO3qoVgTCUOZ3vG8cSQEL4PJ8NqLOAkes+3mnlYOEEyh5u+vaR0FO5TX8sJzKQUjdMfv1pBCDBRatO3qoVgTCUOZ3vG8cSQEL4PJ8NqLOAkes+3mnlYOEEyh5u+vaR0FO5TX8sJzKQUjdMfv1pBCDBRatO3qoVgTCUOZ3vG8cSQEL4PJ8NqLOAkes+3mnlYOEEyh5u+vaR0FO5TX8sJzKQUjdMfv1pBCDBRatO3qoVgTCUOZ3vG8cSQEL4PJ8NqLOAkes+3mnlYOEEyh5u+vaR0FO5TX8sJzKQUjdMfv1pBCDBRatO3qoVgTCUOZ3vG8cSQEL4PJ8NqLOAkes+3mnlYOEEyh5u+vaR0FO5TX8sJzKQUjdMfv1pBCDBRatO3qoVgTCUOZ3vG8cSQEL4PJ8NqLOAkes+3mnlYOEEyh5u+vaR0FO5TX8sJzKQUjdMfv1pBCDBRatO3qoVgTCUOZ3vG8cSQEL4PJ8NqLOAkes+3mnlYOEEyh5u+vaR0FO5TX8sJzKQUjdMfv'),
                success: new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZUQ0PVajl8q9fGQc+l9ryz3UmBSR3yPDcjkALFFm06+yiWBIJQ5zf8L90JQQsg8rx2Io2CBhnu+3mn1gPDVGn5O+wYx0GOpHX8sl0JwYidcbw3I9ACxVds+3rpFYVCkeY4PKxaB8FM4nU89N8LQQngsnw2Yw6CRxvwO/jm1EMDkyj5e+vZBoGPJTY8s94KQQkcsfv25FADBVbte3soFgTCUOZ3vG8cSQEL4PJ8NqLOAkes+3mnlYOEEyh5u+vaR0FO5TX8sJzKQUjdMfv1pBCDBRatO3qoVgTCUOZ3vG8cSQEL4PJ8NqLOAkes+3mnlYOEEyh5u+vaR0FO5TX8sJzKQUjdMfv1pBCDBRatO3qoVgTCUOZ3vG8cSQEL4PJ8NqLOAkes+3mnlYOEEyh5u+vaR0FO5TX8sJzKQUjdMfv1pBCDBRatO3qoVgTCUOZ3vG8cSQEL4PJ8NqLOAkes+3mnlYOEEyh5u+vaR0FO5TX8sJzKQUjdMfv1pBCDBRatO3qoVgTCUOZ3vG8cSQEL4PJ8NqLOAkes+3mnlYOEEyh5u+vaR0FO5TX8sJzKQUjdMfv1pBCDBRatO3qoVgTCUOZ3vG8cSQEL4PJ8NqLOAkes+3mnlYOEEyh5u+vaR0FO5TX8sJzKQUjdMfv1pBCDBRatO3qoVgTCUOZ3vG8cSQEL4PJ8NqLOAkes+3mnlYOEEyh5u+vaR0FO5TX8sJzKQUjdMfv1pBCDBRatO3qoVgTCUOZ3vG8cSQEL4PJ8NqLOAkes+3mnlYOEEyh5u+vaR0FO5TX8sJzKQUjdMfv1pBCDBRatO3qoVgTCUOZ3vG8cSQEL4PJ8NqLOAkes+3mnlYOEEyh5u+vaR0FO5TX8sJzKQUjdMfv1pBCDBRatO3qoVgTCUOZ3vG8cSQEL4PJ8NqLOAkes+3mnlYOEEyh5u+vaR0FO5TX8sJzKQUjdMfv1pBCDBRatO3qoVgTCUOZ3vG8cSQEL4PJ8NqLOAkes+3mnlYOEEyh5u+vaR0FO5TX8sJzKQUjdMfv1pBCDBRatO3qoVgTCUOZ3vG8cSQEL4PJ8NqLOAkes+3mnlYOEEyh5u+vaR0FO5TX8sJzKQUjdMfv1pBCDBRatO3qoVgTCUOZ3vG8cSQEL4PJ8NqLOAkes+3mnlYOEEyh5u+vaR0FO5TX8sJzKQUjdMfv')
            },

            showToast(title, message, type = 'success', duration = 3000, broadcast = true) {
                const container = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                
                const icons = {
                    success: '',
                    warning: '',
                    info: '',
                    order: ''
                };
                
                toast.innerHTML = `
                    <div class="toast-icon">${icons[type] || icons.success}</div>
                    <div class="toast-content">
                        <div class="toast-title">${title}</div>
                        <div class="toast-message">${message}</div>
                    </div>
                    <button class="toast-close" onclick="this.parentElement.classList.add('exit')">×</button>
                `;
                
                container.appendChild(toast);
                
                // Broadcast notification to all devices via Firebase
                if (broadcast && window.db && window.dbRef && window.dbSet) {
                    try {
                        window.dbSet(window.dbRef(window.db, 'notifications'), {
                            title: title,
                            message: message,
                            type: type,
                            timestamp: Date.now()
                        });
                    } catch (error) {
                        console.error('Error broadcasting notification:', error);
                    }
                }
                
                // Auto remove after duration
                setTimeout(() => {
                    toast.classList.add('exit');
                    setTimeout(() => {
                        if (toast.parentElement) {
                            toast.remove();
                        }
                    }, 300);
                }, duration);
            },

            async init() {
                try {
                    await this.loadStockStatus();
                } catch (e) {
                    console.log('Could not load stock status:', e.message);
                }
                
                this.renderMenu();
                this.setupFirebaseListeners();
                this.initializeShift();
            },

            async loadStockStatus() {
                try {
                    const snapshot = await window.dbGet(window.dbRef(window.db, 'menu-stock-status'));
                    if (snapshot.exists()) {
                        const savedStock = snapshot.val();
                        this.menuItems.forEach(item => {
                            if (savedStock[item.id] !== undefined) {
                                item.inStock = savedStock[item.id];
                            }
                        });
                        this.renderMenu();
                    }
                } catch (error) {
                    console.error('Error loading stock status:', error);
                }
            },

            async saveStockStatus() {
                try {
                    const stockStatus = {};
                    this.menuItems.forEach(item => {
                        stockStatus[item.id] = item.inStock;
                    });
                    await window.dbSet(window.dbRef(window.db, 'menu-stock-status'), stockStatus);
                } catch (error) {
                    console.error('Error saving stock status:', error);
                }
            },

            playSound(type) {
                try {
                    this.sounds[type].currentTime = 0;
                    this.sounds[type].play().catch(e => console.log('Sound play failed:', e));
                } catch (e) {
                    console.log('Sound error:', e);
                }
            },

            // Helper function to consolidate items with same ID
            consolidateItems(items) {
                const consolidated = {};
                items.forEach(item => {
                    const key = item.id || item.name;
                    if (consolidated[key]) {
                        consolidated[key].quantity += 1;
                    } else {
                        consolidated[key] = {
                            ...item,
                            quantity: 1
                        };
                    }
                });
                return Object.values(consolidated);
            },

            addPin(digit) {
                if (this.pin.length < 4) {
                    this.pin += digit;
                    document.getElementById('pinDisplay').textContent = '•'.repeat(this.pin.length);
                    // Sound removed
                }
            },

            clearPin() {
                this.pin = '';
                document.getElementById('pinDisplay').textContent = '';
                document.getElementById('pinDisplay').classList.remove('error');
                // Sound removed
            },

            checkPin() {
                if (this.pin === this.correctPin) {
                    // Sound removed
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('mainApp').classList.remove('hidden');
                    this.clearPin();
                } else {
                    document.getElementById('pinDisplay').classList.add('error');
                    // Sound removed
                    setTimeout(() => {
                        this.clearPin();
                    }, 500);
                }
            },

            renderMenu() {
                const grid = document.getElementById('menuGrid');
                
                // Filter items by category
                const filteredItems = this.currentCategory === 'all' 
                    ? this.menuItems 
                    : this.menuItems.filter(item => item.category === this.currentCategory);
                
                if (filteredItems.length === 0) {
                    grid.innerHTML = '<div class="empty-state">No items in this category</div>';
                    return;
                }
                
                grid.innerHTML = filteredItems.map(item => {
                    const isOutOfStock = this.stockEnabled && !item.inStock;
                    
                    let stockBadge = '';
                    if (this.stockEnabled) {
                        if (isOutOfStock) {
                            stockBadge = '<div style="position: absolute; top: 10px; right: 10px; background: var(--warning); color: var(--text-primary); padding: 6px 10px; font-size: 10px; font-weight: 700; letter-spacing: 1px; z-index: 10; border-radius: 2px;">OUT OF STOCK</div>';
                        } else {
                            stockBadge = '<div style="position: absolute; top: 10px; right: 10px; background: var(--accent); color: var(--bg-primary); padding: 6px 10px; font-size: 10px; font-weight: 700; letter-spacing: 1px; z-index: 10; border-radius: 2px;">IN STOCK</div>';
                        }
                    } else {
                        stockBadge = '<div style="position: absolute; top: 10px; right: 10px; background: var(--accent); color: var(--bg-primary); padding: 6px 10px; font-size: 10px; font-weight: 700; letter-spacing: 1px; z-index: 10; border-radius: 2px;">IN STOCK</div>';
                    }
                    
                    return `
                        <div class="menu-item ${isOutOfStock ? 'disabled' : ''}" onclick="${isOutOfStock ? '' : `app.addToOrder(${item.id})`}" style="${isOutOfStock ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                            ${stockBadge}
                            <div class="menu-item-content">
                                <h3>${item.name}</h3>
                                <div class="price">RM ${item.price.toFixed(2)}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            filterCategory(category) {
                this.currentCategory = category;
                
                // Update active button
                document.querySelectorAll('.category-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');
                
                this.renderMenu();
                // Sound removed
            },

            addToOrder(itemId) {
                const item = this.menuItems.find(i => i.id === itemId);
                if (!item) return;
                
                // Check stock availability
                if (this.stockEnabled && !item.inStock) {
                    this.showNotification(`${item.name} is out of stock!`, '⚠️', 'OUT OF STOCK');
                    return;
                }
                
                // Check if item already exists in order
                const existingItem = this.currentOrder.find(orderItem => orderItem.id === itemId);
                
                if (existingItem) {
                    // Increment quantity if item exists
                    existingItem.quantity = (existingItem.quantity || 1) + 1;
                } else {
                    // Add new item with quantity 1
                    this.currentOrder.push({...item, quantity: 1});
                }
                
                this.updateOrderDisplay();
                // Sound removed
            },

            removeFromOrder(index) {
                this.currentOrder.splice(index, 1);
                this.updateOrderDisplay();
                // Sound removed
            },

            updateOrderDisplay() {
                const orderItemsDiv = document.getElementById('orderItems');
                
                // Calculate subtotal (with discounts)
                const subtotal = this.currentOrder.reduce((sum, item) => {
                    const quantity = item.quantity || 1;
                    const price = item.discountedPrice !== undefined ? item.discountedPrice : item.price;
                    return sum + (price * quantity);
                }, 0);

                if (this.currentOrder.length === 0) {
                    orderItemsDiv.innerHTML = '<div class="empty-state">No items added</div>';
                } else {
                    orderItemsDiv.innerHTML = this.currentOrder.map((item, index) => {
                        const quantity = item.quantity || 1;
                        const originalPrice = item.price;
                        const currentPrice = item.discountedPrice !== undefined ? item.discountedPrice : item.price;
                        const itemTotal = currentPrice * quantity;
                        const hasDiscount = item.discountedPrice !== undefined && item.discountedPrice !== item.price;
                        
                        return `
                            <div class="order-item">
                                <div class="item-details">
                                    <h4>${item.name} ${quantity > 1 ? `(x${quantity})` : ''}</h4>
                                    <div class="item-price">
                                        ${hasDiscount ? `<span style="text-decoration: line-through; color: var(--text-secondary); font-size: 12px;">RM ${originalPrice.toFixed(2)}</span> ` : ''}
                                        RM ${currentPrice.toFixed(2)} 
                                        ${quantity > 1 ? `• Total: RM ${itemTotal.toFixed(2)}` : ''}
                                        ${hasDiscount ? `<span style="color: var(--warning); font-size: 11px; margin-left: 8px;">DISCOUNTED</span>` : ''}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button class="remove-btn" style="background: var(--warning); font-size: 11px; padding: 8px 12px;" onclick="app.openDiscountModal(${index})">DISCOUNT</button>
                                    <button class="remove-btn" onclick="app.removeFromOrder(${index})">Remove</button>
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                document.getElementById('subtotal').textContent = `RM ${subtotal.toFixed(2)}`;
                document.getElementById('totalAmount').textContent = `RM ${subtotal.toFixed(2)}`;
            },

            async clearOrder() {
                if (this.currentOrder.length === 0) return;
                const confirmed = await this.showConfirm('Clear current order?');
                if (confirmed) {
                    this.currentOrder = [];
                    this.updateOrderDisplay();
                    // Sound removed
                }
            },

            async openDiscountModal(itemIndex) {
                // Require admin password
                const password = await this.showPasswordModal('ADMIN ACCESS REQUIRED', 'Enter admin password to apply discount:');
                if (password !== this.adminPassword) {
                    await this.showNotification('Incorrect password. Access denied.', '🔒', 'ACCESS DENIED');
                    return;
                }

                const item = this.currentOrder[itemIndex];
                if (!item) return;

                this.currentDiscountItemIndex = itemIndex;
                this.currentDiscountType = 'percentage';

                // Update modal
                document.getElementById('discountItemName').textContent = item.name;
                const originalPrice = item.price;
                const quantity = item.quantity || 1;
                document.getElementById('discountOriginalPrice').textContent = `Original Price: RM ${originalPrice.toFixed(2)} ${quantity > 1 ? `(x${quantity} = RM ${(originalPrice * quantity).toFixed(2)})` : ''}`;
                
                // Reset inputs
                document.getElementById('discountAmount').value = '';
                document.getElementById('discountNewPrice').textContent = `RM ${originalPrice.toFixed(2)}`;
                
                // Set discount type buttons
                this.setDiscountType('percentage');
                
                // Show modal
                document.getElementById('discountModal').classList.add('active');
                
                // Add input listener for preview
                const input = document.getElementById('discountAmount');
                input.addEventListener('input', () => this.updateDiscountPreview());
                
                // Sound removed
            },

            setDiscountType(type) {
                this.currentDiscountType = type;
                
                const percentageBtn = document.getElementById('discountTypePercentage');
                const fixedBtn = document.getElementById('discountTypeFixed');
                
                if (type === 'percentage') {
                    percentageBtn.style.background = 'var(--accent)';
                    percentageBtn.style.color = 'var(--bg-primary)';
                    fixedBtn.style.background = 'var(--bg-tertiary)';
                    fixedBtn.style.color = 'var(--text-primary)';
                    document.getElementById('discountAmount').placeholder = 'Enter percentage (e.g., 10)';
                } else {
                    fixedBtn.style.background = 'var(--accent)';
                    fixedBtn.style.color = 'var(--bg-primary)';
                    percentageBtn.style.background = 'var(--bg-tertiary)';
                    percentageBtn.style.color = 'var(--text-primary)';
                    document.getElementById('discountAmount').placeholder = 'Enter amount (e.g., 5.00)';
                }
                
                this.updateDiscountPreview();
                // Sound removed
            },

            updateDiscountPreview() {
                const item = this.currentOrder[this.currentDiscountItemIndex];
                if (!item) return;

                const originalPrice = item.price;
                const discountAmount = parseFloat(document.getElementById('discountAmount').value) || 0;
                
                let newPrice = originalPrice;
                
                if (this.currentDiscountType === 'percentage') {
                    const discount = (originalPrice * discountAmount) / 100;
                    newPrice = originalPrice - discount;
                } else {
                    newPrice = originalPrice - discountAmount;
                }
                
                // Ensure price doesn't go negative
                newPrice = Math.max(0, newPrice);
                
                document.getElementById('discountNewPrice').textContent = `RM ${newPrice.toFixed(2)}`;
            },

            async applyDiscount() {
                const item = this.currentOrder[this.currentDiscountItemIndex];
                if (!item) return;

                const discountAmount = parseFloat(document.getElementById('discountAmount').value) || 0;
                
                if (discountAmount <= 0) {
                    await this.showNotification('Please enter a valid discount amount', 'ℹ️');
                    return;
                }

                const originalPrice = item.price;
                let newPrice = originalPrice;
                
                if (this.currentDiscountType === 'percentage') {
                    if (discountAmount > 100) {
                        await this.showNotification('Percentage cannot exceed 100%', '⚠️', 'ERROR');
                        return;
                    }
                    const discount = (originalPrice * discountAmount) / 100;
                    newPrice = originalPrice - discount;
                } else {
                    if (discountAmount > originalPrice) {
                        await this.showNotification('Discount cannot exceed item price', '⚠️', 'ERROR');
                        return;
                    }
                    newPrice = originalPrice - discountAmount;
                }
                
                // Apply discount
                item.discountedPrice = newPrice;
                item.discountType = this.currentDiscountType;
                item.discountAmount = discountAmount;
                
                this.updateOrderDisplay();
                this.closeDiscountModal();
                // Sound removed
                await this.showNotification('Discount applied successfully!', '✓', 'SUCCESS');
                
                const discountText = this.currentDiscountType === 'percentage' 
                    ? `${discountAmount}% off` 
                    : `RM ${discountAmount} off`;
                this.showToast('DISCOUNT APPLIED', `${item.name} - ${discountText}`, 'warning');
            },

            closeDiscountModal() {
                document.getElementById('discountModal').classList.remove('active');
                // Sound removed
            },

            async processPayment(method) {
                if (this.currentOrder.length === 0) {
                    await this.showNotification('Please add items to order', 'ℹ️');
                    return;
                }

                // Calculate total with quantities and discounts
                const total = this.currentOrder.reduce((sum, item) => {
                    const quantity = item.quantity || 1;
                    const price = item.discountedPrice !== undefined ? item.discountedPrice : item.price;
                    return sum + (price * quantity);
                }, 0);
                
                this.currentPaymentMethod = method;
                this.currentPaymentTotal = total;

                // Clear customer name field
                document.getElementById('posCustomerName').value = '';

                // Update modal
                document.getElementById('paymentTotal').textContent = total.toFixed(2);
                
                // Set title based on payment method
                const titles = {
                    'cash': 'CASH PAYMENT',
                    'card': 'CARD PAYMENT',
                    'ewallet': 'E-WALLET PAYMENT'
                };
                document.getElementById('paymentMethodTitle').textContent = titles[method];

                // Show/hide cash input section
                const cashSection = document.getElementById('cashInputSection');
                const changeSection = document.getElementById('changeSection');
                const cashInput = document.getElementById('cashReceived');
                
                if (method === 'cash') {
                    cashSection.style.display = 'block';
                    changeSection.style.display = 'none';
                    cashInput.value = '';
                    cashInput.focus();
                } else {
                    cashSection.style.display = 'none';
                    changeSection.style.display = 'none';
                }

                document.getElementById('paymentModal').classList.add('active');
                // Sound removed
            },

            calculateChange() {
                const cashReceived = parseFloat(document.getElementById('cashReceived').value) || 0;
                const total = this.currentPaymentTotal;
                const change = cashReceived - total;
                
                const changeSection = document.getElementById('changeSection');
                const insufficientWarning = document.getElementById('insufficientWarning');
                const confirmBtn = document.getElementById('confirmPaymentBtn');

                if (cashReceived > 0) {
                    if (change >= 0) {
                        changeSection.style.display = 'block';
                        document.getElementById('changeAmount').textContent = change.toFixed(2);
                        insufficientWarning.style.display = 'none';
                        confirmBtn.disabled = false;
                        confirmBtn.style.opacity = '1';
                    } else {
                        changeSection.style.display = 'none';
                        insufficientWarning.style.display = 'block';
                        confirmBtn.disabled = true;
                        confirmBtn.style.opacity = '0.5';
                    }
                } else {
                    changeSection.style.display = 'none';
                    insufficientWarning.style.display = 'none';
                }
            },

            async confirmPayment() {
                // Validate cash payment
                if (this.currentPaymentMethod === 'cash') {
                    const cashReceived = parseFloat(document.getElementById('cashReceived').value) || 0;
                    if (cashReceived < this.currentPaymentTotal) {
                        return; // Button should be disabled anyway
                    }
                }

                // Get customer name
                const customerName = document.getElementById('posCustomerName').value.trim();

                // Close payment modal first
                this.closePaymentModal();

                // Ask if order should be sent to kitchen
                const sendToKitchen = await this.showConfirm('Send this order to kitchen?');
                
                // Calculate original total and discount amount
                let originalTotal = 0;
                let totalDiscount = 0;
                let hasDiscount = false;
                
                // Expand items with quantities into separate items for kitchen
                const expandedItems = [];
                this.currentOrder.forEach(item => {
                    const quantity = item.quantity || 1;
                    const originalPrice = item.price; // This is always the original price from menuItems
                    const currentPrice = item.discountedPrice !== undefined ? item.discountedPrice : item.price;
                    
                    // Always calculate original total
                    originalTotal += originalPrice * quantity;
                    
                    const itemHasDiscount = item.discountedPrice !== undefined && item.discountedPrice !== item.price;
                    
                    if (itemHasDiscount) {
                        hasDiscount = true;
                        totalDiscount += (originalPrice - currentPrice) * quantity;
                    }
                    
                    for (let i = 0; i < quantity; i++) {
                        const expandedItem = {
                            id: item.id,
                            name: item.name,
                            price: currentPrice, // Use discounted price if available
                            category: item.category
                        };
                        
                        // Only add discount-related fields if item actually has discount
                        if (itemHasDiscount) {
                            expandedItem.originalPrice = originalPrice;
                            expandedItem.hasDiscount = true;
                            expandedItem.discountType = item.discountType;
                            expandedItem.discountAmount = item.discountAmount;
                        }
                        
                        expandedItems.push(expandedItem);
                    }
                });

                const order = {
                    id: Date.now(),
                    items: expandedItems,
                    total: this.currentPaymentTotal,
                    originalTotal: hasDiscount ? originalTotal : undefined,
                    totalDiscount: hasDiscount ? totalDiscount : undefined,
                    hasDiscount: hasDiscount,
                    paymentMethod: this.currentPaymentMethod,
                    customerName: customerName || null,
                    timestamp: new Date().toISOString(),
                    displayTime: new Date().toLocaleString('en-MY', { 
                        day: '2-digit',
                        month: 'short',
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: true
                    }),
                    status: 'pending',
                    orderType: 'normal' // Mark as normal order
                };

                try {
                    if (sendToKitchen) {
                        if (window.db && window.dbRef && window.dbSet) {
                            await this.addOrderToKitchen(order);
                        }
                    }
                    
                    // Always update shift stats
                    if (window.db && window.dbRef && window.dbSet) {
                        await this.updateShiftStats(order);
                    }
                    
                    this.currentOrder = [];
                    this.updateOrderDisplay();
                    // Sound removed
                    
                    if (sendToKitchen) {
                        await this.showNotification('Payment confirmed!\nOrder sent to kitchen.', '✓', 'SUCCESS');
                        this.showToast('PAYMENT RECEIVED', `Order #${order.id.toString().slice(-4)} - RM ${order.total.toFixed(2)} paid`, 'success');
                    } else {
                        await this.showNotification('Payment confirmed!', '✓', 'SUCCESS');
                        this.showToast('PAYMENT RECEIVED', `RM ${order.total.toFixed(2)} paid successfully`, 'success');
                    }
                } catch (error) {
                    console.error('Payment error:', error);
                    await this.showNotification('Error processing payment', '⚠️', 'ERROR');
                }
            },

            cancelPayment() {
                this.closePaymentModal();
            },

            closePaymentModal() {
                document.getElementById('paymentModal').classList.remove('active');
                document.getElementById('cashReceived').value = '';
                document.getElementById('changeSection').style.display = 'none';
                document.getElementById('insufficientWarning').style.display = 'none';
                // Sound removed
            },

            async addOrderToKitchen(order) {
                if (!window.db || !window.dbRef || !window.dbPush || !window.dbSet) {
                    console.error('Firebase not available');
                    throw new Error('Database not available');
                }
                const orderRef = window.dbPush(window.dbRef(window.db, 'kitchen-orders'));
                await window.dbSet(orderRef, order);
                console.log('Order added to kitchen:', order.id);
                
                // Show toast notification
                const orderType = order.orderType === 'preorder' ? 'Preorder' : 'Order';
                this.showToast('NEW ORDER', `${orderType} #${order.id.toString().slice(-4)} added to kitchen`, 'order');
            },

            async updateShiftStats(order) {
                if (!window.db || !window.dbRef || !window.dbGet || !window.dbSet) {
                    console.log('Firebase not available, skipping shift stats update');
                    return;
                }
                
                try {
                    const shiftRef = window.dbRef(window.db, 'current-shift');
                    const snapshot = await window.dbGet(shiftRef);
                    
                    let shiftData = snapshot.exists() ? snapshot.val() : {
                        startTime: new Date().toISOString(),
                        totalSales: 0,
                        orderCount: 0,
                        paymentMethods: { cash: 0, card: 0, ewallet: 0, preorder: 0 },
                        itemsSold: {},
                        totalDiscounts: 0,
                        discountedOrders: 0,
                        orderTypes: { normal: 0, preorder: 0 }
                    };

                    // Update totals
                    shiftData.totalSales = (shiftData.totalSales || 0) + order.total;
                    shiftData.orderCount = (shiftData.orderCount || 0) + 1;
                    
                    // Track discounts
                    if (order.hasDiscount) {
                        shiftData.totalDiscounts = (shiftData.totalDiscounts || 0) + (order.totalDiscount || 0);
                        shiftData.discountedOrders = (shiftData.discountedOrders || 0) + 1;
                    }
                    
                    // Track order types
                    if (!shiftData.orderTypes) {
                        shiftData.orderTypes = { normal: 0, preorder: 0 };
                    }
                    if (order.orderType === 'preorder') {
                        shiftData.orderTypes.preorder = (shiftData.orderTypes.preorder || 0) + 1;
                    } else {
                        shiftData.orderTypes.normal = (shiftData.orderTypes.normal || 0) + 1;
                    }
                    
                    // Update payment methods
                    if (!shiftData.paymentMethods) {
                        shiftData.paymentMethods = { cash: 0, card: 0, ewallet: 0, preorder: 0 };
                    }
                    shiftData.paymentMethods[order.paymentMethod] = 
                        (shiftData.paymentMethods[order.paymentMethod] || 0) + order.total;

                    // Update items sold
                    if (!shiftData.itemsSold) {
                        shiftData.itemsSold = {};
                    }
                    
                    order.items.forEach(item => {
                        if (!shiftData.itemsSold[item.name]) {
                            shiftData.itemsSold[item.name] = { count: 0, revenue: 0 };
                        }
                        shiftData.itemsSold[item.name].count += 1;
                        shiftData.itemsSold[item.name].revenue += item.price;
                    });

                    await window.dbSet(shiftRef, shiftData);
                    console.log('✓ Shift stats updated:', {
                        totalSales: shiftData.totalSales,
                        orderCount: shiftData.orderCount,
                        discounts: shiftData.totalDiscounts
                    });
                } catch (error) {
                    console.error('Error updating shift stats:', error);
                    // Silent fail - don't interrupt order flow
                }
            },

            async initializeShift() {
                if (!window.db || !window.dbRef || !window.dbGet || !window.dbSet) {
                    console.log('Firebase not available, skipping shift initialization');
                    return;
                }
                
                try {
                    const shiftRef = window.dbRef(window.db, 'current-shift');
                    const snapshot = await window.dbGet(shiftRef);
                    
                    if (!snapshot.exists()) {
                        await window.dbSet(shiftRef, {
                            startTime: new Date().toISOString(),
                            totalSales: 0,
                            orderCount: 0,
                            paymentMethods: { cash: 0, card: 0, ewallet: 0, preorder: 0 },
                            itemsSold: {}
                        });
                    }
                } catch (error) {
                    console.error('Error initializing shift:', error);
                }
            },

            setupFirebaseListeners() {
                if (!window.db || !window.dbRef || !window.dbOnValue) {
                    console.log('Firebase not available, skipping listeners');
                    return;
                }
                
                try {
                    const ordersRef = window.dbRef(window.db, 'kitchen-orders');
                    window.dbOnValue(ordersRef, (snapshot) => {
                        if (this.currentMode === 'kitchen') {
                            this.renderKitchenOrders(snapshot.val());
                        } else if (this.currentMode === 'history') {
                            this.renderHistory();
                        }
                        this.updateSyncStatus(true);
                    }, (error) => {
                        console.error('Firebase listener error:', error);
                        this.updateSyncStatus(false);
                    });

                    const pickupRef = window.dbRef(window.db, 'pickup-orders');
                    window.dbOnValue(pickupRef, (snapshot) => {
                        if (this.currentMode === 'pickup') {
                            this.renderPickupOrders(snapshot.val());
                        }
                    });

                    const preordersRef = window.dbRef(window.db, 'preorders');
                    window.dbOnValue(preordersRef, (snapshot) => {
                        if (this.currentMode === 'preorder') {
                            const preorders = snapshot.val();
                            this.renderPreorderList(preorders ? Object.values(preorders) : []);
                        }
                    });
                    
                    // Listen for notifications from other devices
                    const notificationsRef = window.dbRef(window.db, 'notifications');
                    this.lastNotificationTimestamp = 0; // Track last shown notification
                    
                    window.dbOnValue(notificationsRef, (snapshot) => {
                        if (snapshot.exists()) {
                            const notification = snapshot.val();
                            // Only show if notification is new and recent (within last 5 seconds)
                            const notificationTime = notification.timestamp;
                            const now = Date.now();
                            
                            // Prevent showing the same notification twice
                            if (notificationTime > this.lastNotificationTimestamp && now - notificationTime < 5000) {
                                this.lastNotificationTimestamp = notificationTime;
                                // Show toast without broadcasting (broadcast=false to prevent loop)
                                this.showToast(notification.title, notification.message, notification.type, 3000, false);
                            }
                        }
                    });
                } catch (error) {
                    console.error('Error setting up Firebase listeners:', error);
                }
            },

            updateSyncStatus(connected) {
                const dot = document.getElementById('syncDot');
                const status = document.getElementById('syncStatus');
                
                if (connected) {
                    dot.classList.remove('disconnected');
                    status.textContent = 'SYNCED';
                } else {
                    dot.classList.add('disconnected');
                    status.textContent = 'OFFLINE';
                }
            },

            switchMode(mode) {
                this.currentMode = mode;
                
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-mode="${mode}"]`).classList.add('active');

                document.getElementById('posMode').classList.add('hidden');
                document.getElementById('kitchenMode').classList.add('hidden');
                document.getElementById('pickupMode').classList.add('hidden');
                document.getElementById('preorderMode').classList.add('hidden');
                document.getElementById('historyMode').classList.add('hidden');

                if (mode === 'pos') {
                    document.getElementById('posMode').classList.remove('hidden');
                } else if (mode === 'kitchen') {
                    document.getElementById('kitchenMode').classList.remove('hidden');
                    this.loadKitchenOrders();
                } else if (mode === 'pickup') {
                    document.getElementById('pickupMode').classList.remove('hidden');
                    this.loadPickupOrders();
                } else if (mode === 'preorder') {
                    document.getElementById('preorderMode').classList.remove('hidden');
                    this.loadPreorders();
                } else if (mode === 'history') {
                    document.getElementById('historyMode').classList.remove('hidden');
                    this.renderHistory();
                }

                // Sound removed
            },

            async loadKitchenOrders() {
                try {
                    const snapshot = await window.dbGet(window.dbRef(window.db, 'kitchen-orders'));
                    this.renderKitchenOrders(snapshot.val());
                } catch (error) {
                    console.error('Error loading kitchen orders:', error);
                }
            },

            async loadPickupOrders() {
                try {
                    const snapshot = await window.dbGet(window.dbRef(window.db, 'pickup-orders'));
                    this.renderPickupOrders(snapshot.val());
                } catch (error) {
                    console.error('Error loading pickup orders:', error);
                }
            },

            renderPickupOrders(orders) {
                const pickupDiv = document.getElementById('pickupMode');
                
                if (!orders) {
                    pickupDiv.innerHTML = '<div class="empty-state">No orders ready for pickup</div>';
                    return;
                }

                const orderArray = Object.entries(orders).map(([key, order]) => ({
                    firebaseKey: key,
                    ...order
                }));
                
                if (orderArray.length === 0) {
                    pickupDiv.innerHTML = '<div class="empty-state">No orders ready for pickup</div>';
                    return;
                }

                // Separate preorders and walk-in orders
                const preorders = orderArray.filter(order => order.orderType === 'preorder');
                const walkIns = orderArray.filter(order => order.orderType !== 'preorder');

                let html = '';

                // Preorder Section
                html += '<div style="margin-bottom: 40px;">';
                html += '<div style="font-family: \'Bebas Neue\', sans-serif; font-size: 28px; letter-spacing: 3px; color: var(--accent); margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid var(--accent);">PREORDER</div>';
                
                if (preorders.length === 0) {
                    html += '<div style="text-align: center; color: var(--text-secondary); padding: 30px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 4px;">No preorders ready</div>';
                } else {
                    html += preorders.map(order => this.renderPickupOrder(order)).join('');
                }
                html += '</div>';

                // Walk-in Section
                html += '<div>';
                html += '<div style="font-family: \'Bebas Neue\', sans-serif; font-size: 28px; letter-spacing: 3px; color: var(--accent); margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid var(--accent);">WALK-IN</div>';
                
                if (walkIns.length === 0) {
                    html += '<div style="text-align: center; color: var(--text-secondary); padding: 30px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 4px;">No walk-in orders ready</div>';
                } else {
                    html += walkIns.map(order => this.renderPickupOrder(order)).join('');
                }
                html += '</div>';

                pickupDiv.innerHTML = html;
            },

            renderPickupOrder(order) {
                // Consolidate items
                const consolidatedItems = this.consolidateItems(order.items);
                
                return `
                    <div class="kitchen-order" style="border-left: 4px solid var(--accent); margin-bottom: 20px;">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div style="font-family: 'Bebas Neue', sans-serif; font-size: 48px; letter-spacing: 4px; color: var(--accent); margin-bottom: 10px;">
                                ${order.customerName || 'ORDER #' + order.id.toString().slice(-4)}
                            </div>
                            <div style="font-size: 12px; color: var(--text-secondary); letter-spacing: 2px;">
                                ${order.displayTime} • ${order.paymentMethod.toUpperCase()}
                            </div>
                        </div>
                        <ul>
                            ${consolidatedItems.map(item => {
                                const itemTotal = item.price * item.quantity;
                                return `
                                    <li>
                                        <span>${item.name} ${item.quantity > 1 ? `<strong>(x${item.quantity})</strong>` : ''}</span>
                                        <span>RM ${item.quantity > 1 ? itemTotal.toFixed(2) : item.price.toFixed(2)}</span>
                                    </li>
                                `;
                            }).join('')}
                        </ul>
                        <div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid var(--border); font-family: 'Bebas Neue', sans-serif; font-size: 24px; text-align: center;">TOTAL: RM ${order.total.toFixed(2)}</div>
                        <button class="action-btn" style="background: var(--accent); border-color: var(--accent); color: var(--bg-primary);" onclick="app.orderPickedUp('${order.firebaseKey}')">ORDER PICKED UP</button>
                    </div>
                `;
            },

            async orderPickedUp(firebaseKey) {
                if (!window.db || !window.dbRef || !window.dbGet || !window.dbSet) {
                    await this.showNotification('Database not available', '⚠️', 'ERROR');
                    return;
                }
                
                try {
                    // Get the order data
                    const orderSnapshot = await window.dbGet(window.dbRef(window.db, `pickup-orders/${firebaseKey}`));
                    if (orderSnapshot.exists()) {
                        const order = orderSnapshot.val();
                        
                        // Add to history with completed status
                        const historyOrder = {
                            ...order,
                            status: 'completed',
                            pickedUpAt: new Date().toISOString()
                        };
                        
                        await window.dbSet(window.dbRef(window.db, `kitchen-orders/${firebaseKey}`), historyOrder);
                        
                        // Remove from pickup
                        await window.dbSet(window.dbRef(window.db, `pickup-orders/${firebaseKey}`), null);
                        
                        // Sound removed
                        await this.showNotification('Order marked as picked up!', '✓', 'SUCCESS');
                        console.log('Order picked up and moved to history:', order.id);
                        
                        // Show toast notification
                        const orderType = order.orderType === 'preorder' ? 'Preorder' : 'Order';
                        this.showToast('ORDER PICKED UP', `${orderType} #${order.id.toString().slice(-4)} collected by customer`, 'info');
                    }
                } catch (error) {
                    console.error('Error marking order as picked up:', error);
                    await this.showNotification('Error marking order as picked up', '⚠️', 'ERROR');
                }
            },

            renderKitchenOrders(orders) {
                const kitchenDiv = document.getElementById('kitchenMode');
                
                if (!orders) {
                    kitchenDiv.innerHTML = '<div class="empty-state">No orders in kitchen</div>';
                    return;
                }

                const orderArray = Object.entries(orders).map(([key, order]) => ({
                    firebaseKey: key,
                    ...order
                }));

                const pendingOrders = orderArray.filter(order => order.status === 'pending');
                
                if (pendingOrders.length === 0) {
                    kitchenDiv.innerHTML = '<div class="empty-state">No pending orders</div>';
                    return;
                }

                // Store orders for deletion reference
                this.currentKitchenOrders = {};
                pendingOrders.forEach(order => {
                    this.currentKitchenOrders[order.firebaseKey] = order;
                });

                kitchenDiv.innerHTML = pendingOrders.map(order => {
                    // Consolidate items
                    const consolidatedItems = this.consolidateItems(order.items);
                    
                    return `
                        <div class="kitchen-order">
                            <h3>Order #${order.id}</h3>
                            <div class="order-time">${order.displayTime} • ${order.paymentMethod.toUpperCase()}</div>
                            ${order.customerName ? `<div class="order-time">Customer: ${order.customerName}</div>` : ''}
                            ${order.notes ? `<div class="order-notes">${order.notes}</div>` : ''}
                            <ul>
                                ${consolidatedItems.map(item => {
                                    const itemTotal = item.price * item.quantity;
                                    const hasDiscount = item.hasDiscount || (item.originalPrice && item.originalPrice !== item.price);
                                    const originalPrice = item.originalPrice || item.price;
                                    
                                    return `
                                        <li style="position: relative;">
                                            ${hasDiscount ? `<div style="position: absolute; top: -8px; left: 0; font-size: 10px; color: var(--text-secondary); text-decoration: line-through;">RM ${originalPrice.toFixed(2)}</div>` : ''}
                                            <span style="${hasDiscount ? 'padding-top: 12px;' : ''}">${item.name} ${item.quantity > 1 ? `<strong>(x${item.quantity})</strong>` : ''} ${hasDiscount ? '<span style="color: var(--warning); font-size: 11px; margin-left: 5px; font-weight: 700;">DISC</span>' : ''}</span>
                                            <span style="${hasDiscount ? 'padding-top: 12px; color: var(--warning);' : ''}">RM ${item.quantity > 1 ? itemTotal.toFixed(2) : item.price.toFixed(2)}</span>
                                        </li>
                                    `;
                                }).join('')}
                            </ul>
                            <div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid var(--border); font-family: 'Bebas Neue', sans-serif; font-size: 24px; text-align: center;">TOTAL: RM ${order.total.toFixed(2)}</div>
                            <button class="action-btn" onclick="app.completeOrder('${order.firebaseKey}')">MARK AS COMPLETED</button>
                            <button class="action-btn" style="background: var(--warning); border-color: var(--warning);" onclick="app.deleteOrderById('${order.firebaseKey}')">DELETE ORDER (ADMIN)</button>
                        </div>
                    `;
                }).join('');
            },

            async completeOrder(firebaseKey) {
                if (!window.db || !window.dbRef || !window.dbGet || !window.dbSet) {
                    await this.showNotification('Database not available', '⚠️', 'ERROR');
                    return;
                }
                
                try {
                    // Get the order data first
                    const orderSnapshot = await window.dbGet(window.dbRef(window.db, `kitchen-orders/${firebaseKey}`));
                    if (orderSnapshot.exists()) {
                        const order = orderSnapshot.val();
                        
                        // Move to pickup area
                        const pickupRef = window.dbRef(window.db, `pickup-orders/${firebaseKey}`);
                        await window.dbSet(pickupRef, {
                            ...order,
                            movedToPickup: new Date().toISOString()
                        });
                        
                        // Also add to history with status 'pending' so it shows in history immediately
                        const historyOrder = {
                            ...order,
                            status: 'pending', // Mark as pending (awaiting pickup)
                            movedToPickup: new Date().toISOString()
                        };
                        await window.dbSet(window.dbRef(window.db, `kitchen-orders/${firebaseKey}`), historyOrder);
                        
                        // Sound removed
                        console.log('Order completed and moved to pickup:', order.id);
                        
                        // Show toast notification
                        const orderType = order.orderType === 'preorder' ? 'Preorder' : 'Order';
                        this.showToast('ORDER READY', `${orderType} #${order.id.toString().slice(-4)} ready for pickup`, 'success');
                    }
                } catch (error) {
                    console.error('Error completing order:', error);
                    await this.showNotification('Error completing order', '⚠️', 'ERROR');
                }
            },

            async deleteOrderById(firebaseKey) {
                // Require admin password
                const password = await this.showPasswordModal('ADMIN ACCESS REQUIRED', 'Enter admin password to delete this order:');
                if (password !== this.adminPassword) {
                    await this.showNotification('Incorrect password. Access denied.', '🔒', 'ACCESS DENIED');
                    return;
                }

                try {
                    // Get the order data from Firebase first
                    const orderSnapshot = await window.dbGet(window.dbRef(window.db, `kitchen-orders/${firebaseKey}`));
                    
                    if (!orderSnapshot.exists()) {
                        await this.showNotification('Order not found', 'ℹ️');
                        return;
                    }
                    
                    const orderData = orderSnapshot.val();
                    const total = orderData.total;
                    const paymentMethod = orderData.paymentMethod;
                    const items = orderData.items;

                    // Confirm deletion
                    const confirmed = await this.showConfirm(`Delete this order?\n\nThis will remove RM ${total.toFixed(2)} from the shift report and reverse all statistics.\n\nThis action cannot be undone.`);
                    if (!confirmed) return;
                    
                    // Get current shift data
                    const shiftSnapshot = await window.dbGet(window.dbRef(window.db, 'current-shift'));
                    if (shiftSnapshot.exists()) {
                        const shift = shiftSnapshot.val();
                        
                        // Reverse the statistics
                        shift.totalSales = Math.max(0, (shift.totalSales || 0) - total);
                        shift.orderCount = Math.max(0, (shift.orderCount || 0) - 1);
                        
                        // Reverse payment method
                        if (!shift.paymentMethods) {
                            shift.paymentMethods = { cash: 0, card: 0, ewallet: 0 };
                        }
                        shift.paymentMethods[paymentMethod] = Math.max(0, (shift.paymentMethods[paymentMethod] || 0) - total);
                        
                        // Reverse items sold
                        if (!shift.itemsSold) {
                            shift.itemsSold = {};
                        }
                        
                        items.forEach(item => {
                            if (shift.itemsSold[item.name]) {
                                shift.itemsSold[item.name].count = Math.max(0, (shift.itemsSold[item.name].count || 0) - 1);
                                shift.itemsSold[item.name].revenue = Math.max(0, (shift.itemsSold[item.name].revenue || 0) - item.price);
                                
                                // Remove item if count reaches 0
                                if (shift.itemsSold[item.name].count <= 0) {
                                    delete shift.itemsSold[item.name];
                                }
                            }
                        });
                        
                        // Update shift in Firebase
                        await window.dbSet(window.dbRef(window.db, 'current-shift'), shift);
                    }
                    
                    // Delete the order from kitchen-orders
                    await window.dbSet(window.dbRef(window.db, `kitchen-orders/${firebaseKey}`), null);
                    
                    // Sound removed
                    await this.showNotification('Order deleted and statistics updated successfully!', '✓', 'SUCCESS');
                } catch (error) {
                    console.error('Error deleting order:', error);
                    await this.showNotification('Error: ' + error.message, '⚠️', 'ERROR');
                }
            },

            async deleteOrder(firebaseKey, total, paymentMethod, itemsJson) {
                // Legacy function - redirect to new one
                await this.deleteOrderById(firebaseKey);
            },

            async loadPreorders() {
                try {
                    const snapshot = await window.dbGet(window.dbRef(window.db, 'preorders'));
                    const preorders = snapshot.val();
                    this.renderPreorderList(preorders ? Object.values(preorders) : []);
                } catch (error) {
                    console.error('Error loading preorders:', error);
                }
            },

            openPreorderModal() {
                this.preorderItems = [];
                document.getElementById('preorderCustomer').value = '';
                document.getElementById('preorderTotal').textContent = '0.00';
                document.getElementById('preorderSelectedItems').innerHTML = '<div class="empty-state" style="padding: 20px;">No items selected</div>';
                
                const grid = document.getElementById('preorderMenuGrid');
                grid.innerHTML = this.menuItems.map(item => {
                    const isOutOfStock = this.stockEnabled && !item.inStock;
                    
                    let stockBadge = '';
                    if (this.stockEnabled) {
                        if (isOutOfStock) {
                            stockBadge = '<div style="position: absolute; top: 10px; right: 10px; background: var(--warning); color: var(--text-primary); padding: 6px 10px; font-size: 10px; font-weight: 700; letter-spacing: 1px; z-index: 10; border-radius: 2px;">OUT OF STOCK</div>';
                        } else {
                            stockBadge = '<div style="position: absolute; top: 10px; right: 10px; background: var(--accent); color: var(--bg-primary); padding: 6px 10px; font-size: 10px; font-weight: 700; letter-spacing: 1px; z-index: 10; border-radius: 2px;">IN STOCK</div>';
                        }
                    } else {
                        stockBadge = '<div style="position: absolute; top: 10px; right: 10px; background: var(--accent); color: var(--bg-primary); padding: 6px 10px; font-size: 10px; font-weight: 700; letter-spacing: 1px; z-index: 10; border-radius: 2px;">IN STOCK</div>';
                    }
                    
                    return `
                        <div class="menu-item ${isOutOfStock ? 'disabled' : ''}" onclick="${isOutOfStock ? '' : `app.addToPreorder(${item.id})`}" style="${isOutOfStock ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                            ${stockBadge}
                            <div class="menu-item-content">
                                <h3>${item.name}</h3>
                                <div class="price">RM ${item.price.toFixed(2)}</div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('preorderModal').classList.add('active');
                // Sound removed
            },

            closePreorderModal() {
                document.getElementById('preorderModal').classList.remove('active');
                // Sound removed
            },

            addToPreorder(itemId) {
                const item = this.menuItems.find(i => i.id === itemId);
                if (!item) return;
                
                // Check stock availability
                if (this.stockEnabled && !item.inStock) {
                    this.showNotification(`${item.name} is out of stock!`, '⚠️', 'OUT OF STOCK');
                    return;
                }
                
                // Check if item already exists in preorder
                const existingItem = this.preorderItems.find(orderItem => orderItem.id === itemId);
                
                if (existingItem) {
                    // Increment quantity if item exists
                    existingItem.quantity = (existingItem.quantity || 1) + 1;
                } else {
                    // Add new item with quantity 1
                    this.preorderItems.push({...item, quantity: 1});
                }
                
                const total = this.preorderItems.reduce((sum, item) => {
                    const quantity = item.quantity || 1;
                    return sum + (item.price * quantity);
                }, 0);
                document.getElementById('preorderTotal').textContent = total.toFixed(2);
                
                // Update selected items display
                this.updatePreorderItemsList();
                // Sound removed
            },

            updatePreorderItemsList() {
                const selectedDiv = document.getElementById('preorderSelectedItems');
                
                if (this.preorderItems.length === 0) {
                    selectedDiv.innerHTML = '<div class="empty-state" style="padding: 20px;">No items selected</div>';
                    return;
                }

                selectedDiv.innerHTML = this.preorderItems.map((item, index) => {
                    const quantity = item.quantity || 1;
                    const itemTotal = item.price * quantity;
                    return `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border);">
                            <div style="flex: 1;">
                                <div style="font-size: 14px; font-weight: 500;">${item.name} ${quantity > 1 ? `(x${quantity})` : ''}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">RM ${item.price.toFixed(2)} ${quantity > 1 ? `• Total: RM ${itemTotal.toFixed(2)}` : ''}</div>
                            </div>
                            <button onclick="app.removeFromPreorder(${index})" style="background: transparent; border: 1px solid var(--border); color: var(--text-secondary); padding: 5px 10px; cursor: pointer; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; transition: all 0.2s;">Remove</button>
                        </div>
                    `;
                }).join('');
            },

            removeFromPreorder(index) {
                this.preorderItems.splice(index, 1);
                const total = this.preorderItems.reduce((sum, item) => {
                    const quantity = item.quantity || 1;
                    return sum + (item.price * quantity);
                }, 0);
                document.getElementById('preorderTotal').textContent = total.toFixed(2);
                this.updatePreorderItemsList();
                // Sound removed
            },

            async createPreorder() {
                const customer = document.getElementById('preorderCustomer').value.trim();

                if (!customer || this.preorderItems.length === 0) {
                    await this.showNotification('Please fill in customer name and add items', 'ℹ️');
                    return;
                }

                // Expand items with quantities into separate items
                const expandedItems = [];
                this.preorderItems.forEach(item => {
                    const quantity = item.quantity || 1;
                    for (let i = 0; i < quantity; i++) {
                        expandedItems.push({
                            id: item.id,
                            name: item.name,
                            price: item.price,
                            category: item.category
                        });
                    }
                });

                const total = this.preorderItems.reduce((sum, item) => {
                    const quantity = item.quantity || 1;
                    return sum + (item.price * quantity);
                }, 0);

                const preorder = {
                    id: Date.now(),
                    customerName: customer,
                    items: expandedItems,
                    total: total,
                    createdAt: new Date().toISOString(),
                    displayTime: new Date().toLocaleString('en-MY', { 
                        day: '2-digit',
                        month: 'short',
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: true
                    }),
                    status: 'pending',
                    paymentStatus: 'unpaid',
                    type: 'preorder'
                };

                try {
                    const preorderRef = window.dbPush(window.dbRef(window.db, 'preorders'));
                    await window.dbSet(preorderRef, preorder);
                    
                    this.closePreorderModal();
                    // Sound removed
                    
                    // Show toast notification
                    this.showToast('PREORDER ADDED', `Preorder for ${customer} created successfully`, 'success');
                } catch (error) {
                    console.error('Error creating preorder:', error);
                    await this.showNotification('Error creating preorder', '⚠️', 'ERROR');
                }
            },

            renderPreorderList(preorders = []) {
                const listDiv = document.getElementById('preorderList');
                
                const pending = preorders.filter(p => p.status === 'pending');
                
                if (pending.length === 0) {
                    listDiv.innerHTML = '<div class="empty-state">No preorders</div>';
                    return;
                }
                
                listDiv.innerHTML = pending.map(preorder => {
                    const isPaid = preorder.paymentStatus === 'paid';
                    const paymentBadge = isPaid 
                        ? '<div style="display: inline-block; background: var(--accent); color: var(--bg-primary); padding: 5px 14px; font-size: 11px; font-weight: 700; letter-spacing: 1px; margin-left: 10px; border-radius: 2px;">PAID</div>'
                        : '<div style="display: inline-block; background: var(--warning); color: var(--text-primary); padding: 5px 14px; font-size: 11px; font-weight: 700; letter-spacing: 1px; margin-left: 10px; border-radius: 2px;">UNPAID</div>';
                    
                    // Consolidate items
                    const consolidatedItems = this.consolidateItems(preorder.items);
                    
                    return `
                        <div class="kitchen-order preorder">
                            <div class="order-badge preorder">Preorder</div>
                            <h3>${preorder.customerName} ${paymentBadge}</h3>
                            <div class="order-time">${preorder.displayTime}</div>
                            <ul>
                                ${consolidatedItems.map(item => {
                                    const itemTotal = item.price * item.quantity;
                                    return `
                                        <li>
                                            <span>${item.name} ${item.quantity > 1 ? `<strong>(x${item.quantity})</strong>` : ''}</span>
                                            <span>RM ${item.quantity > 1 ? itemTotal.toFixed(2) : item.price.toFixed(2)}</span>
                                        </li>
                                    `;
                                }).join('')}
                            </ul>
                            <div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid var(--border); font-family: 'Bebas Neue', sans-serif; font-size: 24px; text-align: center;">TOTAL: RM ${preorder.total.toFixed(2)}</div>
                            ${!isPaid ? `<button class="action-btn" style="margin-top: 15px; background: var(--accent); border-color: var(--accent); color: var(--bg-primary);" onclick="app.confirmPreorderPayment(${preorder.id})">Confirm Payment</button>` : ''}
                            <button class="action-btn" style="${!isPaid ? 'opacity: 0.5;' : ''}" onclick="app.sendToKitchen(${preorder.id})" ${!isPaid ? 'disabled' : ''}>Send to Kitchen</button>
                            <button class="action-btn" onclick="app.cancelPreorder(${preorder.id})">Cancel</button>
                        </div>
                    `;
                }).join('');
            },

            async confirmPreorderPayment(preorderId) {
                try {
                    const snapshot = await window.dbGet(window.dbRef(window.db, 'preorders'));
                    const preorders = snapshot.val();
                    
                    if (preorders) {
                        for (let key in preorders) {
                            if (preorders[key].id === preorderId) {
                                const preorder = preorders[key];
                                
                                // Store current preorder info
                                this.currentPreorderId = preorderId;
                                this.currentPreorderKey = key;
                                this.selectedPreorderPayment = null;
                                
                                // Show payment modal
                                document.getElementById('preorderPaymentTotal').textContent = preorder.total.toFixed(2);
                                
                                // Reset button states
                                document.querySelectorAll('.preorder-payment-btn').forEach(btn => {
                                    btn.classList.remove('selected');
                                });
                                document.getElementById('confirmPreorderPaymentBtn').style.opacity = '0.5';
                                document.getElementById('confirmPreorderPaymentBtn').style.pointerEvents = 'none';
                                
                                document.getElementById('preorderPaymentModal').classList.add('active');
                                // Sound removed
                                break;
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error confirming payment:', error);
                }
            },

            selectPreorderPayment(method) {
                this.selectedPreorderPayment = method;
                
                // Update button states
                document.querySelectorAll('.preorder-payment-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
                event.target.closest('.preorder-payment-btn').classList.add('selected');
                
                // Enable confirm button
                document.getElementById('confirmPreorderPaymentBtn').style.opacity = '1';
                document.getElementById('confirmPreorderPaymentBtn').style.pointerEvents = 'auto';
                
                // Sound removed
            },

            async finalizePreorderPayment() {
                if (!this.selectedPreorderPayment) return;
                
                try {
                    await window.dbSet(window.dbRef(window.db, `preorders/${this.currentPreorderKey}/paymentStatus`), 'paid');
                    await window.dbSet(window.dbRef(window.db, `preorders/${this.currentPreorderKey}/paymentMethod`), this.selectedPreorderPayment);
                    
                    this.closePreorderPaymentModal();
                    // Sound removed
                    await this.showNotification('Payment confirmed!', '✓', 'SUCCESS');
                } catch (error) {
                    console.error('Error finalizing payment:', error);
                    await this.showNotification('Error confirming payment', '⚠️', 'ERROR');
                }
            },

            closePreorderPaymentModal() {
                document.getElementById('preorderPaymentModal').classList.remove('active');
                this.selectedPreorderPayment = null;
                // Sound removed
            },

            // Password Modal Functions
            showPasswordModal(title, message) {
                return new Promise((resolve) => {
                    this.passwordResolve = resolve;
                    document.getElementById('passwordModalTitle').textContent = title;
                    document.getElementById('passwordModalMessage').textContent = message;
                    document.getElementById('passwordInput').value = '';
                    document.getElementById('passwordModal').classList.add('active');
                    setTimeout(() => document.getElementById('passwordInput').focus(), 100);
                    // Sound removed
                });
            },

            submitPassword() {
                const password = document.getElementById('passwordInput').value;
                document.getElementById('passwordModal').classList.remove('active');
                if (this.passwordResolve) {
                    this.passwordResolve(password);
                    this.passwordResolve = null;
                }
                // Sound removed
            },

            cancelPassword() {
                document.getElementById('passwordModal').classList.remove('active');
                if (this.passwordResolve) {
                    this.passwordResolve(null);
                    this.passwordResolve = null;
                }
                // Sound removed
            },

            // Notification Modal Functions
            showNotification(message, icon = 'ℹ️', title = 'NOTIFICATION') {
                return new Promise((resolve) => {
                    this.notificationResolve = resolve;
                    document.getElementById('notificationTitle').textContent = title;
                    document.getElementById('notificationMessage').textContent = message;
                    document.getElementById('notificationIcon').textContent = icon;
                    document.getElementById('notificationModal').classList.add('active');
                    // Sound removed
                });
            },

            closeNotification() {
                document.getElementById('notificationModal').classList.remove('active');
                if (this.notificationResolve) {
                    this.notificationResolve();
                    this.notificationResolve = null;
                }
                // Sound removed
            },

            // Confirm Modal Functions
            showConfirm(message) {
                return new Promise((resolve) => {
                    this.confirmResolve = resolve;
                    document.getElementById('confirmMessage').textContent = message;
                    document.getElementById('confirmModal').classList.add('active');
                    // Sound removed
                });
            },

            acceptConfirm() {
                document.getElementById('confirmModal').classList.remove('active');
                if (this.confirmResolve) {
                    this.confirmResolve(true);
                    this.confirmResolve = null;
                }
                // Sound removed
            },

            cancelConfirm() {
                document.getElementById('confirmModal').classList.remove('active');
                if (this.confirmResolve) {
                    this.confirmResolve(false);
                    this.confirmResolve = null;
                }
                // Sound removed
            },

            async sendToKitchen(preorderId) {
                if (!window.db || !window.dbRef || !window.dbGet || !window.dbSet) {
                    await this.showNotification('Database not available', '⚠️', 'ERROR');
                    return;
                }
                
                try {
                    const snapshot = await window.dbGet(window.dbRef(window.db, 'preorders'));
                    const preorders = snapshot.val();
                    
                    if (preorders) {
                        for (let key in preorders) {
                            if (preorders[key].id === preorderId) {
                                const preorder = preorders[key];
                                
                                if (preorder.paymentStatus !== 'paid') {
                                    await this.showNotification('Please confirm payment first', 'ℹ️');
                                    return;
                                }
                                
                                // Create kitchen order from preorder
                                const kitchenOrder = {
                                    ...preorder,
                                    timestamp: new Date().toISOString(),
                                    displayTime: new Date().toLocaleString('en-MY', { 
                                        day: '2-digit',
                                        month: 'short',
                                        hour: '2-digit',
                                        minute: '2-digit',
                                        hour12: true
                                    }),
                                    status: 'pending',
                                    orderType: 'preorder' // Mark as preorder
                                };
                                
                                // Send to kitchen
                                await this.addOrderToKitchen(kitchenOrder);
                                
                                // Remove from preorders (it's now in kitchen)
                                await window.dbSet(window.dbRef(window.db, `preorders/${key}`), null);
                                
                                // Sound removed
                                await this.showNotification('Order sent to kitchen!', '✓', 'SUCCESS');
                                break;
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error sending to kitchen:', error);
                    await this.showNotification('Error sending to kitchen', '⚠️', 'ERROR');
                }
            },

            async cancelPreorder(preorderId) {
                if (!confirm('Cancel this preorder?')) return;
                
                try {
                    const snapshot = await window.dbGet(window.dbRef(window.db, 'preorders'));
                    const preorders = snapshot.val();
                    
                    if (preorders) {
                        for (let key in preorders) {
                            if (preorders[key].id === preorderId) {
                                await window.dbRemove(window.dbRef(window.db, `preorders/${key}`));
                                // Sound removed
                                break;
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error canceling preorder:', error);
                }
            },

            async renderHistory() {
                const historyDiv = document.getElementById('historyMode');
                
                try {
                    const snapshot = await window.dbGet(window.dbRef(window.db, 'kitchen-orders'));
                    if (!snapshot.exists()) {
                        historyDiv.innerHTML = '<div class="empty-state">No order history</div>';
                        return;
                    }

                    const orders = Object.values(snapshot.val());
                    
                    // Get firebase keys for orders
                    const ordersWithKeys = Object.entries(snapshot.val()).map(([key, order]) => ({
                        firebaseKey: key,
                        ...order
                    }));
                    
                    // Separate pending and completed orders, both normal and preorders
                    const pendingNormal = ordersWithKeys.filter(order => 
                        order.status === 'pending' && order.movedToPickup && order.orderType !== 'preorder'
                    ).reverse();
                    
                    const completedNormal = ordersWithKeys.filter(order => 
                        order.status === 'completed' && order.orderType !== 'preorder'
                    ).reverse();
                    
                    const pendingPreorders = ordersWithKeys.filter(order => 
                        order.status === 'pending' && order.movedToPickup && order.orderType === 'preorder'
                    ).reverse();
                    
                    const completedPreorders = ordersWithKeys.filter(order => 
                        order.status === 'completed' && order.orderType === 'preorder'
                    ).reverse();
                    
                    if (pendingNormal.length === 0 && completedNormal.length === 0 && 
                        pendingPreorders.length === 0 && completedPreorders.length === 0) {
                        historyDiv.innerHTML = '<div class="empty-state">No order history</div>';
                        return;
                    }

                    // Store orders for deletion reference
                    this.currentHistoryOrders = {};
                    ordersWithKeys.forEach(order => {
                        this.currentHistoryOrders[order.firebaseKey] = order;
                    });

                    let html = '';
                    
                    // Normal Orders Section
                    if (pendingNormal.length > 0 || completedNormal.length > 0) {
                        html += '<div style="margin-bottom: 30px;"><h2 style="font-family: \'Bebas Neue\', sans-serif; font-size: 24px; letter-spacing: 3px; color: var(--accent); margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid var(--border);">WALK-IN ORDERS</h2>';
                        html += pendingNormal.map(order => this.renderHistoryOrder(order)).join('');
                        html += completedNormal.map(order => this.renderHistoryOrder(order)).join('');
                        html += '</div>';
                    }
                    
                    // Preorders Section
                    if (pendingPreorders.length > 0 || completedPreorders.length > 0) {
                        html += '<div><h2 style="font-family: \'Bebas Neue\', sans-serif; font-size: 24px; letter-spacing: 3px; color: var(--accent); margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid var(--border);">PREORDERS</h2>';
                        html += pendingPreorders.map(order => this.renderHistoryOrder(order)).join('');
                        html += completedPreorders.map(order => this.renderHistoryOrder(order)).join('');
                        html += '</div>';
                    }

                    historyDiv.innerHTML = html;
                } catch (error) {
                    console.error('Error rendering history:', error);
                }
            },

            renderHistoryOrder(order) {
                // Consolidate items
                const consolidatedItems = this.consolidateItems(order.items);
                
                const discountBadge = order.hasDiscount ? 
                    `<div style="display: inline-block; background: var(--warning); color: var(--bg-primary); padding: 4px 10px; font-size: 10px; font-weight: 700; letter-spacing: 1px; border-radius: 2px; margin-left: 10px;">DISCOUNTED</div>` : '';
                
                const statusText = order.status === 'pending' 
                    ? '<div style="margin-top: 15px; text-align: center; color: var(--warning); font-size: 10px; letter-spacing: 2px; text-transform: uppercase;">⏳ AWAITING PICKUP</div>'
                    : '<div style="margin-top: 15px; text-align: center; color: var(--text-secondary); font-size: 10px; letter-spacing: 2px; text-transform: uppercase;">✓ COMPLETED</div>';
                
                return `
                    <div class="kitchen-order completed">
                        <h3>Order #${order.id} ${discountBadge}</h3>
                        <div class="order-time">${order.displayTime} • ${order.paymentMethod.toUpperCase()}</div>
                        ${order.customerName ? `<div class="order-time">Customer: ${order.customerName}</div>` : ''}
                        ${order.hasDiscount ? `<div class="order-time" style="color: var(--warning);">Original: RM ${order.originalTotal.toFixed(2)} | Discount: -RM ${order.totalDiscount.toFixed(2)}</div>` : ''}
                        <ul>
                            ${consolidatedItems.map(item => {
                                const itemTotal = item.price * item.quantity;
                                const hasItemDiscount = item.hasDiscount || (item.originalPrice && item.originalPrice !== item.price);
                                return `
                                    <li>
                                        <span>
                                            ${item.name} ${item.quantity > 1 ? `<strong>(x${item.quantity})</strong>` : ''}
                                            ${hasItemDiscount ? `<span style="color: var(--warning); font-size: 11px; margin-left: 5px; font-weight: 700;">DISC</span>` : ''}
                                        </span>
                                        <span>RM ${item.quantity > 1 ? itemTotal.toFixed(2) : item.price.toFixed(2)}</span>
                                    </li>
                                `;
                            }).join('')}
                        </ul>
                        <div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid var(--border); font-family: 'Bebas Neue', sans-serif; font-size: 24px; text-align: center;">TOTAL: RM ${order.total.toFixed(2)}</div>
                        ${statusText}
                    </div>
                `;
            },

            async openShiftReport() {
                try {
                    const snapshot = await window.dbGet(window.dbRef(window.db, 'current-shift'));
                    if (!snapshot.exists()) {
                        await this.showNotification('No shift data available', 'ℹ️');
                        return;
                    }

                    const shift = snapshot.val();
                    
                    // Get completed orders from history
                    const ordersSnapshot = await window.dbGet(window.dbRef(window.db, 'kitchen-orders'));
                    let completedOrders = [];
                    if (ordersSnapshot.exists()) {
                        completedOrders = Object.values(ordersSnapshot.val()).filter(o => o.status === 'completed');
                    }
                    
                    const reportContent = document.getElementById('shiftReportContent');

                    // Handle empty itemsSold
                    let itemsHtml = '';
                    if (shift.itemsSold && Object.keys(shift.itemsSold).length > 0) {
                        itemsHtml = Object.entries(shift.itemsSold)
                            .sort((a, b) => b[1].revenue - a[1].revenue)
                            .map(([name, data]) => `
                                <div class="sold-item">
                                    <span>${name}</span>
                                    <span class="sold-item-count">${data.count}x • RM ${data.revenue.toFixed(2)}</span>
                                </div>
                            `).join('');
                    } else {
                        itemsHtml = '<div class="empty-state">No items sold yet</div>';
                    }

                    // Calculate totals
                    const totalCash = shift.paymentMethods?.cash || 0;
                    const totalCard = shift.paymentMethods?.card || 0;
                    const totalEwallet = shift.paymentMethods?.ewallet || 0;
                    const totalDiscounts = shift.totalDiscounts || 0;
                    const discountedOrders = shift.discountedOrders || 0;
                    const normalOrders = shift.orderTypes?.normal || 0;
                    const preorders = shift.orderTypes?.preorder || 0;
                    
                    // Format shift start time
                    const startTime = new Date(shift.startTime);
                    const duration = Math.floor((Date.now() - startTime.getTime()) / (1000 * 60)); // minutes
                    const hours = Math.floor(duration / 60);
                    const minutes = duration % 60;
                    
                    // Completed orders summary
                    let ordersHtml = '';
                    if (completedOrders.length > 0) {
                        ordersHtml = completedOrders.slice(-10).reverse().map(order => `
                            <div style="padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 4px; margin-bottom: 8px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span style="font-weight: 600;">#${order.id.toString().slice(-4)}</span>
                                    <span style="color: var(--accent);">RM ${order.total.toFixed(2)}</span>
                                </div>
                                <div style="font-size: 11px; color: var(--text-secondary);">
                                    ${order.displayTime} • ${order.paymentMethod.toUpperCase()} • ${order.orderType === 'preorder' ? 'PREORDER' : 'WALK-IN'}
                                    ${order.hasDiscount ? ` • DISCOUNTED` : ''}
                                </div>
                            </div>
                        `).join('');
                    } else {
                        ordersHtml = '<div class="empty-state">No completed orders yet</div>';
                    }

                    reportContent.innerHTML = `
                        <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 4px; margin-bottom: 20px; border: 1px solid var(--border);">
                            <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">Shift Duration</div>
                            <div style="font-size: 20px; font-family: 'Bebas Neue', sans-serif; letter-spacing: 2px;">${hours}h ${minutes}m</div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">Started: ${startTime.toLocaleString('en-MY')}</div>
                        </div>
                        
                        <div class="report-grid">
                            <div class="report-stat" style="grid-column: span 2;">
                                <div class="stat-label">Total Sales</div>
                                <div class="stat-value" style="font-size: 32px;">RM ${(shift.totalSales || 0).toFixed(2)}</div>
                            </div>
                            <div class="report-stat">
                                <div class="stat-label">Total Orders</div>
                                <div class="stat-value">${shift.orderCount || 0}</div>
                            </div>
                            <div class="report-stat">
                                <div class="stat-label">Avg Order</div>
                                <div class="stat-value">RM ${shift.orderCount > 0 ? (shift.totalSales / shift.orderCount).toFixed(2) : '0.00'}</div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0;">
                            <div style="background: var(--bg-tertiary); padding: 15px; border-radius: 4px; border: 1px solid var(--border);">
                                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">WALK-IN ORDERS</div>
                                <div style="font-size: 24px; font-family: 'Bebas Neue', sans-serif; color: var(--accent);">${normalOrders}</div>
                            </div>
                            <div style="background: var(--bg-tertiary); padding: 15px; border-radius: 4px; border: 1px solid var(--border);">
                                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">PREORDERS</div>
                                <div style="font-size: 24px; font-family: 'Bebas Neue', sans-serif; color: var(--accent);">${preorders}</div>
                            </div>
                        </div>
                        
                        ${totalDiscounts > 0 ? `
                        <div style="background: var(--warning); color: var(--bg-primary); padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">TOTAL DISCOUNTS GIVEN</div>
                                    <div style="font-size: 24px; font-family: 'Bebas Neue', sans-serif; letter-spacing: 2px;">RM ${totalDiscounts.toFixed(2)}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 20px; font-family: 'Bebas Neue', sans-serif;">${discountedOrders}</div>
                                    <div style="font-size: 11px; opacity: 0.9;">Orders</div>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="report-grid" style="margin-bottom: 20px;">
                            <div class="report-stat">
                                <div class="stat-label">💵 Cash</div>
                                <div class="stat-value">RM ${totalCash.toFixed(2)}</div>
                            </div>
                            <div class="report-stat">
                                <div class="stat-label">💳 Card</div>
                                <div class="stat-value">RM ${totalCard.toFixed(2)}</div>
                            </div>
                            <div class="report-stat">
                                <div class="stat-label">📱 E-Wallet</div>
                                <div class="stat-value">RM ${totalEwallet.toFixed(2)}</div>
                            </div>
                        </div>
                        
                        <div class="items-sold-list" style="margin-bottom: 20px;">
                            <h4>Top Items Sold (by revenue)</h4>
                            ${itemsHtml}
                        </div>
                        
                        <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 4px; border: 1px solid var(--border);">
                            <h4 style="margin-bottom: 15px;">Recent Completed Orders (Last 10)</h4>
                            ${ordersHtml}
                        </div>
                    `;

                    document.getElementById('shiftReportModal').classList.add('active');
                    // Sound removed
                } catch (error) {
                    console.error('Error opening shift report:', error);
                    await this.showNotification('Error loading shift report: ' + error.message, '⚠️', 'ERROR');
                }
            },

            closeShiftReport() {
                document.getElementById('shiftReportModal').classList.remove('active');
                // Sound removed
            },

            async clearShift() {
                // Require admin password
                const password = await this.showPasswordModal('ADMIN ACCESS REQUIRED', 'Enter admin password to clear shift:');
                if (password !== this.adminPassword) {
                    await this.showNotification('Incorrect password. Access denied.', '🔒', 'ACCESS DENIED');
                    return;
                }

                const confirmed = await this.showConfirm('Clear current shift? This will save the current shift report and reset all statistics.');
                if (!confirmed) return;
                
                try {
                    // Save current shift before clearing
                    const shiftSnapshot = await window.dbGet(window.dbRef(window.db, 'current-shift'));
                    if (shiftSnapshot.exists()) {
                        const shift = shiftSnapshot.val();
                        
                        // Get completed orders for the report
                        const ordersSnapshot = await window.dbGet(window.dbRef(window.db, 'kitchen-orders'));
                        let completedOrders = [];
                        if (ordersSnapshot.exists()) {
                            completedOrders = Object.values(ordersSnapshot.val()).filter(o => o.status === 'completed');
                        }
                        
                        const savedShift = {
                            ...shift,
                            completedOrders: completedOrders,
                            endTime: new Date().toISOString(),
                            savedAt: new Date().toLocaleString('en-MY', {
                                day: '2-digit',
                                month: 'short',
                                year: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit',
                                hour12: true
                            })
                        };
                        
                        // Save to shift-history
                        const historyRef = window.dbRef(window.db, 'shift-history');
                        await window.dbSet(window.dbPush(historyRef), savedShift);
                        console.log('✓ Shift saved to history');
                    }
                    
                    // Reset shift data
                    await window.dbSet(window.dbRef(window.db, 'current-shift'), {
                        startTime: new Date().toISOString(),
                        totalSales: 0,
                        orderCount: 0,
                        paymentMethods: { cash: 0, card: 0, ewallet: 0, preorder: 0 },
                        itemsSold: {},
                        totalDiscounts: 0,
                        discountedOrders: 0,
                        orderTypes: { normal: 0, preorder: 0 }
                    });
                    
                    // Clear all kitchen orders (history)
                    await window.dbSet(window.dbRef(window.db, 'kitchen-orders'), null);
                    
                    this.closeShiftReport();
                    // Sound removed
                    await this.showNotification('Shift saved and cleared successfully!', '✓', 'SUCCESS');
                } catch (error) {
                    console.error('Error clearing shift:', error);
                    await this.showNotification('Error clearing shift', '⚠️', 'ERROR');
                }
            },

            async saveShiftReport() {
                try {
                    const snapshot = await window.dbGet(window.dbRef(window.db, 'current-shift'));
                    if (!snapshot.exists()) {
                        await this.showNotification('No shift data to save', 'ℹ️');
                        return;
                    }

                    const shift = snapshot.val();
                    const savedShift = {
                        ...shift,
                        endTime: new Date().toISOString(),
                        savedAt: new Date().toLocaleString('en-MY', {
                            day: '2-digit',
                            month: 'short',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: true
                        })
                    };

                    const historyRef = window.dbPush(window.dbRef(window.db, 'shift-history'));
                    await window.dbSet(historyRef, savedShift);
                    
                    // Sound removed
                    await this.showNotification('Shift report saved successfully!', '✓', 'SUCCESS');
                } catch (error) {
                    console.error('Error saving shift:', error);
                    await this.showNotification('Error saving shift report', '⚠️', 'ERROR');
                }
            },

            async viewShiftHistory() {
                try {
                    const snapshot = await window.dbGet(window.dbRef(window.db, 'shift-history'));
                    const historyContent = document.getElementById('shiftHistoryContent');
                    
                    if (!snapshot.exists()) {
                        historyContent.innerHTML = '<div class="empty-state">No shift history available</div>';
                    } else {
                        const history = Object.entries(snapshot.val()).map(([key, shift]) => ({
                            key,
                            ...shift
                        })).reverse();

                        historyContent.innerHTML = history.map(shift => `
                            <div class="shift-card" onclick="app.viewShiftDetails('${shift.key}')">
                                <div class="shift-card-date">${shift.savedAt}</div>
                                <div class="shift-card-stats">
                                    <span>Sales: RM ${shift.totalSales.toFixed(2)}</span>
                                    <span>Orders: ${shift.orderCount}</span>
                                </div>
                            </div>
                        `).join('');
                    }

                    document.getElementById('shiftHistoryModal').classList.add('active');
                    // Sound removed
                } catch (error) {
                    console.error('Error loading shift history:', error);
                    await this.showNotification('Error loading shift history', '⚠️', 'ERROR');
                }
            },

            async viewShiftDetails(shiftKey) {
                try {
                    const snapshot = await window.dbGet(window.dbRef(window.db, `shift-history/${shiftKey}`));
                    if (!snapshot.exists()) return;

                    const shift = snapshot.val();
                    const reportContent = document.getElementById('shiftReportContent');

                    const itemsHtml = Object.entries(shift.itemsSold)
                        .sort((a, b) => b[1].count - a[1].count)
                        .map(([name, data]) => `
                            <div class="sold-item">
                                <span>${name}</span>
                                <span class="sold-item-count">${data.count}x • RM ${data.revenue.toFixed(2)}</span>
                            </div>
                        `).join('');

                    reportContent.innerHTML = `
                        <div style="text-align: center; margin-bottom: 20px; padding: 15px; background: var(--bg-tertiary); border: 1px solid var(--border);">
                            <div style="color: var(--text-secondary); font-size: 11px; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 5px;">SAVED ON</div>
                            <div style="font-family: 'Bebas Neue', sans-serif; font-size: 20px; letter-spacing: 2px;">${shift.savedAt}</div>
                        </div>
                        <div class="report-grid">
                            <div class="report-stat">
                                <div class="stat-label">Total Sales</div>
                                <div class="stat-value">RM ${shift.totalSales.toFixed(2)}</div>
                            </div>
                            <div class="report-stat">
                                <div class="stat-label">Orders</div>
                                <div class="stat-value">${shift.orderCount}</div>
                            </div>
                            <div class="report-stat">
                                <div class="stat-label">Cash</div>
                                <div class="stat-value">RM ${(shift.paymentMethods.cash || 0).toFixed(2)}</div>
                            </div>
                            <div class="report-stat">
                                <div class="stat-label">Card</div>
                                <div class="stat-value">RM ${(shift.paymentMethods.card || 0).toFixed(2)}</div>
                            </div>
                            <div class="report-stat">
                                <div class="stat-label">E-Wallet</div>
                                <div class="stat-value">RM ${(shift.paymentMethods.ewallet || 0).toFixed(2)}</div>
                            </div>
                            <div class="report-stat">
                                <div class="stat-label">Preorder</div>
                                <div class="stat-value">RM ${(shift.paymentMethods.preorder || 0).toFixed(2)}</div>
                            </div>
                        </div>
                        <div class="items-sold-list">
                            <h4>Items Sold</h4>
                            ${itemsHtml}
                        </div>
                    `;

                    document.getElementById('shiftHistoryModal').classList.remove('active');
                    document.getElementById('shiftReportModal').classList.add('active');
                    // Sound removed
                } catch (error) {
                    console.error('Error viewing shift details:', error);
                }
            },

            closeShiftHistory() {
                document.getElementById('shiftHistoryModal').classList.remove('active');
                // Sound removed
            },

            async openAdminEdit() {
                // Require admin password
                const password = await this.showPasswordModal('ADMIN ACCESS REQUIRED', 'Enter admin password to access edit mode:');
                if (password !== this.adminPassword) {
                    await this.showNotification('Incorrect password. Access denied.', '🔒', 'ACCESS DENIED');
                    return;
                }

                try {
                    const snapshot = await window.dbGet(window.dbRef(window.db, 'current-shift'));
                    if (!snapshot.exists()) {
                        await this.showNotification('No shift data to edit', 'ℹ️');
                        return;
                    }

                    const shift = snapshot.val();
                    
                    // Populate fields
                    document.getElementById('adminTotalSales').value = shift.totalSales || 0;
                    document.getElementById('adminOrderCount').value = shift.orderCount || 0;
                    document.getElementById('adminCash').value = shift.paymentMethods?.cash || 0;
                    document.getElementById('adminCard').value = shift.paymentMethods?.card || 0;
                    document.getElementById('adminEwallet').value = shift.paymentMethods?.ewallet || 0;
                    
                    // Render items list
                    const itemsDiv = document.getElementById('adminItemsList');
                    if (shift.itemsSold && Object.keys(shift.itemsSold).length > 0) {
                        itemsDiv.innerHTML = Object.entries(shift.itemsSold)
                            .sort((a, b) => b[1].count - a[1].count)
                            .map(([name, data]) => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border);">
                                    <div style="flex: 1;">
                                        <div style="font-size: 14px; font-weight: 500;">${name}</div>
                                    </div>
                                    <div style="display: flex; gap: 15px; align-items: center;">
                                        <div>
                                            <label style="font-size: 10px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; display: block; margin-bottom: 5px;">Count</label>
                                            <input type="number" class="admin-item-count" value="${data.count}" min="0" data-item-name="${name}" style="width: 80px; background: var(--bg-primary); border: 1px solid var(--border); padding: 8px; color: var(--text-primary); font-size: 14px; text-align: center;">
                                        </div>
                                        <div>
                                            <label style="font-size: 10px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; display: block; margin-bottom: 5px;">Revenue (RM)</label>
                                            <input type="number" class="admin-item-revenue" value="${data.revenue.toFixed(2)}" min="0" step="0.01" data-item-name="${name}" style="width: 100px; background: var(--bg-primary); border: 1px solid var(--border); padding: 8px; color: var(--text-primary); font-size: 14px; text-align: center;">
                                        </div>
                                    </div>
                                </div>
                            `).join('');
                    } else {
                        itemsDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-secondary);">No items sold yet</div>';
                    }

                    document.getElementById('adminEditModal').classList.add('active');
                    // Sound removed
                } catch (error) {
                    console.error('Error opening admin edit:', error);
                    await this.showNotification('Error loading shift data', '⚠️', 'ERROR');
                }
            },

            closeAdminEdit() {
                document.getElementById('adminEditModal').classList.remove('active');
                // Sound removed
            },

            async saveAdminEdit() {
                const confirmed = await this.showConfirm('Save these changes to the shift report?');
                if (!confirmed) return;

                try {
                    const snapshot = await window.dbGet(window.dbRef(window.db, 'current-shift'));
                    if (!snapshot.exists()) {
                        await this.showNotification('No shift data found', 'ℹ️');
                        return;
                    }

                    const shift = snapshot.val();
                    
                    // Update main values
                    shift.totalSales = parseFloat(document.getElementById('adminTotalSales').value) || 0;
                    shift.orderCount = parseInt(document.getElementById('adminOrderCount').value) || 0;
                    
                    // Update payment methods
                    shift.paymentMethods = {
                        cash: parseFloat(document.getElementById('adminCash').value) || 0,
                        card: parseFloat(document.getElementById('adminCard').value) || 0,
                        ewallet: parseFloat(document.getElementById('adminEwallet').value) || 0
                    };
                    
                    // Update items sold
                    const countInputs = document.querySelectorAll('.admin-item-count');
                    const revenueInputs = document.querySelectorAll('.admin-item-revenue');
                    
                    shift.itemsSold = shift.itemsSold || {};
                    
                    countInputs.forEach((input, index) => {
                        const itemName = input.dataset.itemName;
                        const count = parseInt(input.value) || 0;
                        const revenue = parseFloat(revenueInputs[index].value) || 0;
                        
                        if (shift.itemsSold[itemName]) {
                            shift.itemsSold[itemName].count = count;
                            shift.itemsSold[itemName].revenue = revenue;
                        }
                    });

                    // Save to database
                    await window.dbSet(window.dbRef(window.db, 'current-shift'), shift);
                    
                    this.closeAdminEdit();
                    this.closeShiftReport();
                    // Sound removed
                    await this.showNotification('Shift data updated successfully!', '✓', 'SUCCESS');
                } catch (error) {
                    console.error('Error saving admin edit:', error);
                    await this.showNotification('Error saving changes', '⚠️', 'ERROR');
                }
            },

            async openStockManager() {
                const toggle = document.getElementById('stockToggle');
                toggle.checked = this.stockEnabled;
                
                // Update status text
                this.updateStockStatusText();
                
                this.renderStockList();
                document.getElementById('stockManagerModal').classList.add('active');
                // Sound removed
            },

            closeStockManager() {
                document.getElementById('stockManagerModal').classList.remove('active');
                // Sound removed
            },

            toggleStock() {
                this.stockEnabled = document.getElementById('stockToggle').checked;
                this.updateStockStatusText();
                this.renderStockList(); // Re-render to update badges
                this.renderMenu(); // Refresh menu
                // Sound removed
            },

            updateStockStatusText() {
                const statusText = document.getElementById('stockStatusText');
                if (this.stockEnabled) {
                    statusText.textContent = 'ENABLED';
                    statusText.style.color = 'var(--accent)';
                } else {
                    statusText.textContent = 'DISABLED';
                    statusText.style.color = 'var(--text-secondary)';
                }
            },

            renderStockList() {
                const listDiv = document.getElementById('stockItemsList');
                
                listDiv.innerHTML = this.menuItems.map(item => {
                    const badge = item.inStock 
                        ? '<span class="stock-badge ok">In Stock</span>'
                        : '<span class="stock-badge out">Out of Stock</span>';
                    
                    return `
                        <div class="stock-item-row" style="padding: 20px; display: flex; justify-content: space-between; align-items: center;">
                            <div class="stock-item-info">
                                <div class="stock-item-name" style="font-size: 16px; margin-bottom: 5px;">${item.name}</div>
                                <div class="stock-item-price">RM ${item.price.toFixed(2)}</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 20px;">
                                ${badge}
                                <label style="position: relative; display: inline-block; width: 70px; height: 40px; cursor: pointer;">
                                    <input type="checkbox" ${item.inStock ? 'checked' : ''} onchange="app.toggleItemStock(${item.id})" style="opacity: 0; width: 0; height: 0;">
                                    <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: ${item.inStock ? 'var(--accent)' : 'var(--bg-primary)'}; transition: .4s; border-radius: 40px; border: 2px solid ${item.inStock ? 'var(--accent)' : 'var(--border)'};"></span>
                                    <span style="position: absolute; content: ''; height: 32px; width: 32px; left: ${item.inStock ? '34px' : '4px'}; bottom: 4px; background-color: ${item.inStock ? 'var(--bg-primary)' : 'var(--text-secondary)'}; transition: .4s; border-radius: 50%;"></span>
                                </label>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            toggleItemStock(itemId) {
                const item = this.menuItems.find(i => i.id === itemId);
                if (item) {
                    item.inStock = !item.inStock;
                    this.renderStockList();
                    // Sound removed
                }
            },

            async saveStock() {
                await this.saveStockStatus(); // Save to Firebase
                this.renderMenu(); // Refresh menu display
                this.closeStockManager();
                // Sound removed
                await this.showNotification('Stock status updated successfully!', '✓', 'SUCCESS');
            },

        };

        // CRITICAL: Expose app to window IMMEDIATELY for onclick handlers
        window.app = app;
        
        // Verify it's accessible
        if (typeof window.app !== 'undefined') {
            console.log('✓ App successfully exposed to window');
            console.log('✓ addPin:', typeof app.addPin);
            console.log('✓ checkPin:', typeof app.checkPin);
            console.log('✓ clearPin:', typeof app.clearPin);
        } else {
            console.error('✗ Failed to expose app to window!');
        }

        // Initialize app when page loads
        window.addEventListener('DOMContentLoaded', () => {
            console.log('DOM Content Loaded');
            // Wait for Firebase to initialize
            setTimeout(() => {
                console.log('Initializing app...');
                app.init();
                
                // Add event listener for cash input
                const cashInput = document.getElementById('cashReceived');
                if (cashInput) {
                    cashInput.addEventListener('input', () => app.calculateChange());
                }
            }, 1000);
        });
    </script>
</body>
</html>
